<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ржорзЗрж╕рж╛рж░рзНрж╕ ржорж╛ржИржирзБ ржПржирзНржЯрж╛рж░ржкрзНрж░рж╛ржЗржЬ (Admin & User)</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:8px}
        .app{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);overflow:hidden;min-height:95vh;display:none}
        .app.active{display:block}
        
        /* Login Screen Styles */
        .login-screen{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
        .login-box{background:#fff;padding:30px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3);width:100%;max-width:360px;text-align:center}
        .login-box h2{color:#667eea;margin-bottom:20px;font-size:24px}
        .login-box input{width:100%;padding:12px;margin-bottom:15px;border:2px solid #dee2e6;border-radius:8px;font-size:16px}
        .login-box input:focus{border-color:#667eea;outline:none}
        .btn-full{width:100%;padding:12px;border:none;border-radius:8px;background:#667eea;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;transition:.2s}
        .btn-full:hover{background:#5a6fd6}
        
        /* Main App Styles */
        .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:14px;text-align:center}
        .header h1{font-size:18px}
        .header small{opacity:.8;font-size:11px}
        .shop-status{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;margin-left:8px;background:rgba(0,0,0,0.2)}
        .shop-status.open{background:#28a745}
        .shop-status.closed{background:#dc3545}
        .shop-closed-msg{background:#f8d7da;color:#721c24;padding:10px;text-align:center;font-weight:bold;margin-bottom:10px;border-radius:6px;display:none}
        
        .tabs{display:flex;overflow-x:auto;background:#f1f3f5;border-bottom:2px solid #dee2e6;-webkit-overflow-scrolling:touch}
        .tabs::-webkit-scrollbar{height:0}
        .tab{flex:0 0 auto;padding:10px 12px;border:none;background:none;font-size:12px;font-weight:600;color:#666;cursor:pointer;white-space:nowrap;border-bottom:3px solid transparent;transition:.2s}
        .tab.active{color:#667eea;border-bottom-color:#667eea;background:#fff}
        .tab:hover{background:#e9ecef}
        .page{display:none;padding:12px;animation:fadeIn .3s}
        .page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .row{display:grid;gap:10px;margin-bottom:10px}
        .row2{grid-template-columns:1fr 1fr}
        .row3{grid-template-columns:1fr 1fr 1fr}
        @media(max-width:500px){.row2,.row3{grid-template-columns:1fr}}
        .field{margin-bottom:10px}
        .field label{display:block;font-size:12px;font-weight:600;color:#333;margin-bottom:3px}
        .field input,.field select,.field textarea{width:100%;padding:9px;border:2px solid #dee2e6;border-radius:6px;font-size:14px;transition:.2s}
        .field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:#667eea}
        .field input:disabled,.field select:disabled{background:#e9ecef;cursor:not-allowed;opacity:0.7}
        
        .btn{padding:9px 16px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:5px}
        .btn:active{transform:scale(.97)}
        .btn:disabled{background:#ccc !important;cursor:not-allowed;opacity:0.6;transform:none !important;filter:grayscale(100%)}
        .btn-p{background:#667eea;color:#fff}.btn-p:hover{background:#5a6fd6}
        .btn-s{background:#28a745;color:#fff}.btn-s:hover{background:#22943e}
        .btn-d{background:#dc3545;color:#fff}.btn-d:hover{background:#c82333}
        .btn-w{background:#ffc107;color:#333}.btn-w:hover{background:#e0a800}
        .btn-g{background:#6c757d;color:#fff}
        .btn-full{width:100%;justify-content:center;padding:11px}
        .card{border:2px solid #e9ecef;border-radius:8px;padding:12px;margin-bottom:12px}
        .card h3{font-size:15px;color:#667eea;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #f1f3f5}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:12px}
        .stat{padding:14px 10px;border-radius:8px;text-align:center;color:#fff}
        .stat h4{font-size:18px;font-weight:700}
        .stat p{font-size:11px;opacity:.9;margin-top:2px}
        .bg1{background:linear-gradient(135deg,#667eea,#764ba2)}
        .bg2{background:linear-gradient(135deg,#28a745,#20c997)}
        .bg3{background:linear-gradient(135deg,#fd7e14,#ffc107)}
        .bg4{background:linear-gradient(135deg,#dc3545,#e83e8c)}
        .bg5{background:linear-gradient(135deg,#17a2b8,#007bff)}
        .bg6{background:linear-gradient(135deg,#6f42c1,#e83e8c)}
        .tbl{width:100%;border-collapse:collapse;font-size:12px}
        .tbl th{background:#f8f9fa;color:#667eea;font-weight:700;text-align:left;padding:8px;border-bottom:2px solid #dee2e6;white-space:nowrap}
        .tbl td{padding:7px 8px;border-bottom:1px solid #eee;white-space:nowrap}
        .tbl tr:hover{background:#f8f9fa}
        .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
        .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}
        .badge-g{background:#d4edda;color:#155724}
        .badge-r{background:#f8d7da;color:#721c24}
        .badge-y{background:#fff3cd;color:#856404}
        .low{color:#dc3545;font-weight:700}
        .alert{padding:10px;border-radius:6px;margin-bottom:10px;font-size:13px}
        .alert-i{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
        .alert-s{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .alert-w{background:#fff3cd;color:#856404;border:1px solid #ffeeba}
        .alert-d{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;align-items:center;justify-content:center;padding:15px}
        .modal-bg.show{display:flex}
        .modal{background:#fff;border-radius:12px;padding:18px;width:100%;max-width:450px;max-height:85vh;overflow-y:auto}
        .modal h3{font-size:16px;color:#667eea;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
        .modal .x{font-size:22px;cursor:pointer;color:#999;padding:0 5px}
        .modal .x:hover{color:#333}
        .summary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:14px;border-radius:8px;margin-bottom:12px}
        .summary h4{text-align:center;margin-bottom:10px;font-size:15px}
        .srow{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.25);font-size:13px}
        .srow:last-child{border-bottom:2px solid #fff;font-weight:700;font-size:15px;margin-top:6px;padding-top:8px}
        .pay-type{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
        .pay-type label{display:flex;align-items:center;gap:5px;padding:8px 12px;background:#f1f3f5;border-radius:6px;cursor:pointer;font-size:13px;flex:1;min-width:90px}
        .pay-type input{accent-color:#667eea}
        .toast{position:fixed;top:12px;right:12px;padding:10px 16px;border-radius:8px;color:#fff;font-size:13px;font-weight:600;z-index:9999;animation:slideIn .3s;box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .toast.success{background:#28a745}
        .toast.error{background:#dc3545}
        .toast.info{background:#17a2b8}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .empty{text-align:center;padding:25px;color:#999}
        .empty span{font-size:36px;display:block;margin-bottom:8px;opacity:.3}
        .btns{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
        
        /* Strict Lock Styles */
        .lock-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);z-index:10;display:none;align-items:center;justify-content:center;text-align:center;padding:20px;color:#dc3545;font-size:18px;font-weight:bold;backdrop-filter:blur(3px)}
        .shop-lock-blur{position:relative}
        .locked .lock-overlay{display:flex}
        /* Force disable all inputs and buttons when locked */
        body.shop-locked input:not([readonly]), 
        body.shop-locked select, 
        body.shop-locked textarea, 
        body.shop-locked button:not(#btnShopOpen) {
            pointer-events: none;
            filter: grayscale(100%);
            opacity: 0.75;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>ЁЯПк ржорж╛ржИржирзБ ржПржирзНржЯрж╛рж░ржкрзНрж░рж╛ржЗржЬ</h2>
        <div class="field">
            <input type="tel" id="loginPhone" placeholder="ржорзЛржмрж╛ржЗрж▓ ржирж╛ржорзНржмрж╛рж░" maxlength="11">
        </div>
        <div class="field">
            <input type="password" id="loginPass" placeholder="ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб">
        </div>
        <button class="btn-full" onclick="performLogin()">ЁЯФС рж▓ржЧржЗржи ржХрж░рзБржи</button>
        <p style="margin-top:15px;font-size:12px;color:#666">ржЕрзНржпрж╛ржбржорж┐ржи ржмрж╛ ржЗржЙржЬрж╛рж░ ржЕржирзБржорзЛржжржи ржкрзНрж░рзЯрзЛржЬржи</p>
    </div>
</div>

<!-- Main App -->
<div class="app" id="mainApp">
    <div class="header">
        <h1>ЁЯПк ржорзЗрж╕рж╛рж░рзНрж╕ ржорж╛ржИржирзБ ржПржирзНржЯрж╛рж░ржкрзНрж░рж╛ржЗржЬ <span id="shopStatusBadge" class="shop-status open">ржЦрзЛрж▓рж╛</span></h1>
        <small id="userRoleBadge">Admin Mode</small>
    </div>

    <div id="shopClosedMsg" class="shop-closed-msg">тЫФ ржжрзЛржХрж╛ржи ржмржирзНржз - рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржЕржирзБржорзЛржжржи ржкрзНрж░рзЯрзЛржЬржи</div>

    <div class="tabs" id="tabBar">
        <button class="tab active" data-tab="dash">ЁЯУК ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</button>
        <button class="tab" data-tab="daily">ЁЯТ╡ ржжрзИржирж┐ржХ</button>
        <button class="tab" data-tab="due">ЁЯСе ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐</button>
        <button class="tab" data-tab="vendue">ЁЯПн ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐</button>
        <button class="tab" data-tab="prod">ЁЯУж ржкржгрзНржп</button>
        <button class="tab" data-tab="vend">ЁЯСд ржнрзЗржирзНржбрж░</button>
        <button class="tab" data-tab="buy">ЁЯЫТ ржХрзНрж░ржпрж╝</button>
        <button class="tab" data-tab="sell">ЁЯТ░ ржмрж┐ржХрзНрж░ржпрж╝</button>
        <button class="tab" data-tab="stock">ЁЯУЛ рж╕рзНржЯржХ</button>
        <button class="tab" data-tab="report">ЁЯУИ рж░рж┐ржкрзЛрж░рзНржЯ</button>
        <button class="tab" data-tab="set">тЪЩя╕П рж╕рзЗржЯрж┐ржВрж╕</button>
    </div>

    <!-- ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб -->
    <div class="page active" id="pg-dash">
        <div class="stats" id="dashStats"></div>
        <div class="card"><h3>тЪая╕П рж╕рзНржЯржХ рж╕рждрж░рзНржХрждрж╛</h3><div id="lowStock"></div></div>
        <div class="card"><h3>ЁЯУК рж╕рж╛ржорзНржкрзНрж░рждрж┐ржХ ржмрж┐ржХрзНрж░ржпрж╝</h3><div id="recentSales"></div></div>
    </div>

    <!-- ржжрзИржирж┐ржХ рж╣рж┐рж╕рж╛ржм -->
    <div class="page" id="pg-daily">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="field"><label>ЁЯУЕ рждрж╛рж░рж┐ржЦ</label><input type="date" id="dailyDate"></div>
            <div id="dailySummary"></div>
            <div class="card">
                <h3>тЮХ ржЦрж░ржЪ ржпрзЛржЧ ржХрж░рзБржи</h3>
                <div class="row row2">
                    <div class="field"><label>ржзрж░ржи *</label>
                        <select id="expCat"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option><option>ржжрзЛржХрж╛ржи ржнрж╛ржбрж╝рж╛</option><option>ржмрж┐ржжрзНржпрзБрзО ржмрж┐рж▓</option><option>ржкрж░рж┐ржмрж╣ржи</option><option>ржХрж░рзНржоржЪрж╛рж░рзА ржмрзЗрждржи</option><option>ржорзЗрж░рж╛ржоржд</option><option>ржЯрзЗрж▓рж┐ржлрзЛржи</option><option>ржЕржирзНржпрж╛ржирзНржп</option></select>
                    </div>
                    <div class="field"><label>ржЯрж╛ржХрж╛ (рз│) *</label><input type="number" id="expAmt" step="0.01" min="0"></div>
                </div>
                <div class="field"><label>ржмрж┐ржмрж░ржг</label><input type="text" id="expDesc" placeholder="ржРржЪрзНржЫрж┐ржХ"></div>
                <div class="btns">
                    <button class="btn btn-s" onclick="addExpense()">тЬЕ рж╕ржВрж░ржХрзНрж╖ржг</button>
                    <button class="btn btn-w" id="btnUpdExp" style="display:none" onclick="updateExpense()">ЁЯФД ржЖржкржбрзЗржЯ</button>
                    <button class="btn btn-g" id="btnCanExp" style="display:none" onclick="cancelExpenseEdit()">тЭМ ржмрж╛рждрж┐рж▓</button>
                </div>
            </div>
            <div class="card"><h3>ЁЯУЛ ржЖржЬржХрзЗрж░ ржЦрж░ржЪ</h3><div id="expList"></div></div>
        </div>
    </div>

    <!-- ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐ ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛ -->
    <div class="page" id="pg-due">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="stats" id="dueStats"></div>
            <div class="card">
                <h3>ЁЯТ░ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐ ржЖржжрж╛ржпрж╝</h3>
                <div class="field"><label>ржХрж╛рж╕рзНржЯржорж╛рж░ *</label><select id="dueCust" onchange="showCustDue()"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option></select></div>
                <div class="row row2">
                    <div class="field"><label>ржмржХрзЗржпрж╝рж╛</label><input type="number" id="custDueAmt" readonly></div>
                    <div class="field"><label>ржЖржжрж╛ржпрж╝ (рз│) *</label><input type="number" id="payAmt" step="0.01" min="0"></div>
                </div>
                <div class="field"><label>рждрж╛рж░рж┐ржЦ</label><input type="date" id="payDate"></div>
                <button class="btn btn-s btn-full" onclick="collectDue()">тЬЕ ржЖржжрж╛ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг</button>
            </div>
            <div class="card"><h3>ЁЯУЛ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐рж░ рждрж╛рж▓рж┐ржХрж╛</h3><div id="dueList"></div></div>
            <div class="card"><h3>ЁЯТ╡ ржХрж╛рж╕рзНржЯржорж╛рж░ ржЖржжрж╛ржпрж╝рзЗрж░ ржЗрждрж┐рж╣рж╛рж╕</h3><div id="payHistory"></div></div>
        </div>
    </div>

    <!-- ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐ ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛ -->
    <div class="page" id="pg-vendue">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="stats" id="vendueStats"></div>
            <div class="card">
                <h3>ЁЯТ░ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐ ржкрж░рж┐рж╢рзЛржз</h3>
                <div class="field"><label>ржнрзЗржирзНржбрж░ *</label><select id="vendueVend" onchange="showVendDue()"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option></select></div>
                <div class="row row2">
                    <div class="field"><label>ржмржХрзЗржпрж╝рж╛</label><input type="number" id="vendDueAmt" readonly></div>
                    <div class="field"><label>ржкрж░рж┐рж╢рзЛржз (рз│) *</label><input type="number" id="vendPayAmt" step="0.01" min="0"></div>
                </div>
                <div class="field"><label>рждрж╛рж░рж┐ржЦ</label><input type="date" id="vendPayDate"></div>
                <button class="btn btn-s btn-full" onclick="payVendorDue()">тЬЕ ржкрж░рж┐рж╢рзЛржз рж╕ржВрж░ржХрзНрж╖ржг</button>
            </div>
            <div class="card"><h3>ЁЯУЛ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐рж░ рждрж╛рж▓рж┐ржХрж╛</h3><div id="vendueList"></div></div>
            <div class="card"><h3>ЁЯТ╡ ржнрзЗржирзНржбрж░ ржкрж░рж┐рж╢рзЛржз ржЗрждрж┐рж╣рж╛рж╕</h3><div id="vendPayHistory"></div></div>
        </div>
    </div>

    <!-- ржкржгрзНржп -->
    <div class="page" id="pg-prod">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="btns"><button class="btn btn-s" onclick="openProdModal()">тЮХ ржирждрзБржи ржкржгрзНржп</button></div>
            <div class="field"><label>ЁЯФН ржЦрзБржБржЬрзБржи</label><input type="text" id="prodSearch" oninput="renderProducts()" placeholder="ржкржгрзНржпрзЗрж░ ржирж╛ржо..."></div>
            <div class="tbl-wrap" id="prodTable"></div>
        </div>
    </div>

    <!-- ржнрзЗржирзНржбрж░ -->
    <div class="page" id="pg-vend">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="btns"><button class="btn btn-s" onclick="openVendModal()">тЮХ ржирждрзБржи ржнрзЗржирзНржбрж░</button></div>
            <div class="tbl-wrap" id="vendTable"></div>
        </div>
    </div>

    <!-- ржХрзНрж░ржпрж╝ -->
    <div class="page" id="pg-buy">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="card">
                <h3 id="buyFrmTitle">ЁЯЫТ ржирждрзБржи ржХрзНрж░ржпрж╝</h3>
                <input type="hidden" id="editBuyId">
                <div class="row row2">
                    <div class="field"><label>рждрж╛рж░рж┐ржЦ *</label><input type="date" id="buyDate"></div>
                    <div class="field"><label>ржнрзЗржирзНржбрж░ *</label><select id="buyVend"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи</option></select></div>
                </div>
                <div class="row row2">
                    <div class="field"><label>ржкржгрзНржп *</label><select id="buyProd"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи</option></select></div>
                    <div class="field"><label>ржкрж░рж┐ржорж╛ржг *</label><input type="number" id="buyQty" step="0.01" min="0.01" oninput="calcBuy()"></div>
                </div>
                <div class="row row2">
                    <div class="field"><label>ржХрзНрж░ржпрж╝ржорзВрж▓рзНржп/ржЗржЙржирж┐ржЯ (рз│) *</label><input type="number" id="buyPrice" step="0.01" min="0.01" oninput="calcBuy()"></div>
                    <div class="field"><label>ржорзЛржЯ (рз│)</label><input type="number" id="buyTotal" readonly></div>
                </div>
                
                <!-- ржХрзНрж░ржпрж╝рзЗрж░ ржкрзЗржорзЗржирзНржЯ ржЯрж╛ржЗржк -->
                <div class="field"><label style="color:#667eea;font-weight:700">ЁЯТ│ ржкрзЗржорзЗржирзНржЯ ржЯрж╛ржЗржк *</label>
                    <div class="pay-type">
                        <label><input type="radio" name="buyPayType" value="cash" checked onchange="toggleBuyPartial()"> ЁЯТ╡ ржиржЧржж</label>
                        <label><input type="radio" name="buyPayType" value="due" onchange="toggleBuyPartial()"> ЁЯТ│ ржмрж╛ржХрж┐</label>
                        <label><input type="radio" name="buyPayType" value="partial" onchange="toggleBuyPartial()"> ЁЯТ░ ржЖржВрж╢рж┐ржХ</label>
                    </div>
                </div>
                <div id="buyPartialDiv" style="display:none">
                    <div class="row row2">
                        <div class="field"><label>ржЬржорж╛ (рз│)</label><input type="number" id="buyPaid" step="0.01" min="0" oninput="calcBuyPartial()"></div>
                        <div class="field"><label>ржмрж╛ржХрж┐ (рз│)</label><input type="number" id="buyDue" readonly class="low"></div>
                    </div>
                </div>
                
                <div class="field"><label>ржирзЛржЯ</label><input type="text" id="buyNote" placeholder="ржРржЪрзНржЫрж┐ржХ"></div>
                <div class="btns">
                    <button class="btn btn-s" id="btnSaveBuy" onclick="addPurchase()">тЬЕ ржХрзНрж░ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг</button>
                    <button class="btn btn-w" id="btnUpdBuy" style="display:none" onclick="updatePurchase()">ЁЯФД ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
                    <button class="btn btn-g" id="btnCanBuy" style="display:none" onclick="resetBuyForm()">тЭМ ржмрж╛рждрж┐рж▓</button>
                </div>
            </div>
            <div class="card"><h3>ЁЯЫТ ржХрзНрж░ржпрж╝ ржЗрждрж┐рж╣рж╛рж╕</h3><div id="buyList"></div></div>
        </div>
    </div>

    <!-- ржмрж┐ржХрзНрж░ржпрж╝ (UPDATED) -->
    <div class="page" id="pg-sell">
        <div class="shop-lock-blur">
            <div class="lock-overlay">тЫФ<br>ржжрзЛржХрж╛ржи ржмржирзНржз</div>
            <div class="card">
                <h3 id="sellFrmTitle">ЁЯТ░ ржирждрзБржи ржмрж┐ржХрзНрж░ржпрж╝</h3>
                <input type="hidden" id="editSellId">
                <div class="row row2">
                    <div class="field"><label>рждрж╛рж░рж┐ржЦ *</label><input type="date" id="sellDate"></div>
                    <div class="field"><label>ржХрж╛рж╕рзНржЯржорж╛рж░</label><input type="text" id="sellCust" placeholder="ржирж╛ржо"></div>
                </div>
                <div class="row row2">
                    <div class="field"><label>ржорзЛржмрж╛ржЗрж▓</label><input type="tel" id="sellPhone" placeholder="рзжрззрзн..."></div>
                    <!-- New: Vendor Selection for Sales -->
                    <div class="field"><label>рж╕рзЛрж░рзНрж╕ ржнрзЗржирзНржбрж░ *</label><select id="sellVendor" onchange="updateSellProductList()"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option></select></div>
                </div>
                <div id="stockInfo" class="alert alert-i" style="display:none"></div>
                <div class="row row2">
                    <div class="field"><label>ржкржгрзНржп *</label><select id="sellProd" onchange="showSellStock()"><option value="">ржкрзНрж░ржержорзЗ ржнрзЗржирзНржбрж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option></select></div>
                    <div class="field"><label>ржкрж░рж┐ржорж╛ржг *</label><input type="number" id="sellQty" step="0.01" min="0.01" oninput="calcSell()"></div>
                </div>
                <div class="row row2">
                    <div class="field"><label>ржмрж┐ржХрзНрж░ржпрж╝ржорзВрж▓рзНржп/ржЗржЙржирж┐ржЯ (рз│) *</label><input type="number" id="sellPrice" step="0.01" min="0.01" oninput="calcSell()"></div>
                    <div class="field"><label>ржорзЛржЯ (рз│)</label><input type="number" id="sellTotal" readonly></div>
                </div>
                <div class="field"><label style="color:#667eea;font-weight:700">ЁЯТ░ ржкрзЗржорзЗржирзНржЯ ржЯрж╛ржЗржк *</label>
                    <div class="pay-type">
                        <label><input type="radio" name="payType" value="cash" checked onchange="togglePartial()"> ЁЯТ╡ ржиржЧржж</label>
                        <label><input type="radio" name="payType" value="due" onchange="togglePartial()"> ЁЯТ│ ржмрж╛ржХрж┐</label>
                        <label><input type="radio" name="payType" value="partial" onchange="togglePartial()"> ЁЯТ░ ржЖржВрж╢рж┐ржХ</label>
                    </div>
                </div>
                <div id="partialDiv" style="display:none">
                    <div class="row row2">
                        <div class="field"><label>ржЬржорж╛ (рз│)</label><input type="number" id="sellPaid" step="0.01" min="0" oninput="calcPartial()"></div>
                        <div class="field"><label>ржмрж╛ржХрж┐ (рз│)</label><input type="number" id="sellDue" readonly class="low"></div>
                    </div>
                </div>
                <div class="btns">
                    <button class="btn btn-s" id="btnSaveSell" onclick="addSale()">тЬЕ ржмрж┐ржХрзНрж░ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг</button>
                    <button class="btn btn-w" id="btnUpdSell" style="display:none" onclick="updateSale()">ЁЯФД ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
                    <button class="btn btn-g" id="btnCanSell" style="display:none" onclick="resetSellForm()">тЭМ ржмрж╛рждрж┐рж▓</button>
                </div>
            </div>
            <div class="card"><h3>ЁЯТ░ ржмрж┐ржХрзНрж░ржпрж╝ ржЗрждрж┐рж╣рж╛рж╕</h3><div id="sellList"></div></div>
        </div>
    </div>

    <!-- рж╕рзНржЯржХ -->
    <div class="page" id="pg-stock">
        <div class="row row2">
             <div class="field"><label>ржнрзЗржирзНржбрж░ ржлрж┐рж▓рзНржЯрж╛рж░</label><select id="stockVendFilter" onchange="renderStock()"><option value="">рж╕ржХрж▓ ржнрзЗржирзНржбрж░</option></select></div>
             <div class="field"><label>ЁЯФН ржЦрзБржБржЬрзБржи</label><input type="text" id="stockSearch" oninput="renderStock()" placeholder="ржкржгрзНржпрзЗрж░ ржирж╛ржо..."></div>
        </div>
        <div class="btns">
            <button class="btn btn-s" onclick="exportStockCSV()">ЁЯУе CSV ржПржХрзНрж╕ржкрзЛрж░рзНржЯ</button>
            <button class="btn btn-p" onclick="printStock()">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ</button>
        </div>
        <div class="tbl-wrap" id="stockTable"></div>
    </div>

    <!-- рж░рж┐ржкрзЛрж░рзНржЯ -->
    <div class="page" id="pg-report">
        <div class="row row2">
            <div class="field"><label>рж╢рзБрж░рзБ</label><input type="date" id="repStart"></div>
            <div class="field"><label>рж╢рзЗрж╖</label><input type="date" id="repEnd"></div>
        </div>
        <div class="btns">
            <button class="btn btn-p" onclick="genReport()">ЁЯУК рж░рж┐ржкрзЛрж░рзНржЯ</button>
            <button class="btn btn-s" onclick="exportFullCSV()">ЁЯУе рж╕ржорзНржкрзВрж░рзНржг CSV</button>
        </div>
        <div id="reportOut"></div>
    </div>

    <!-- рж╕рзЗржЯрж┐ржВрж╕ -->
    <div class="page" id="pg-set">
        <!-- Admin Only Password Section -->
        <div class="card admin-only">
            <h3>тЪЩя╕П ржирж┐рж░рж╛ржкрждрзНрждрж╛ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи)</h3>
            <div class="field"><label>ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб</label><input type="password" id="currPass" placeholder="ржкрзБрж░рж╛ржирзЛ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб"></div>
            <div class="field"><label>ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб</label><input type="password" id="newPass" placeholder="ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб"></div>
            <button class="btn btn-p btn-full" onclick="changePassword()">ЁЯФТ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи</button>
        </div>

        <!-- Admin Only Shop Status -->
        <div class="card admin-only">
            <h3>ЁЯПк ржжрзЛржХрж╛ржи рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи)</h3>
            <div class="pay-type" style="justify-content:center">
                <label class="stat bg2" id="btnShopOpen" style="flex:0 0 auto;padding:15px 20px;margin-right:10px;cursor:pointer" onclick="toggleShopStatus(true)">
                    <span style="font-size:16px;color:#fff">ЁЯЯв ржЦрзЛрж▓рж╛</span>
                </label>
                <label class="stat bg4" id="btnShopClosed" style="flex:0 0 auto;padding:15px 20px;cursor:pointer" onclick="toggleShopStatus(false)">
                    <span style="font-size:16px;color:#fff">ЁЯФ┤ ржмржирзНржз</span>
                </label>
            </div>
            <p style="font-size:12px;color:#666;text-align:center;margin-top:10px">
                ржжрзЛржХрж╛ржи ржмржирзНржз ржерж╛ржХрж▓рзЗ ржХрзЛржирзЛ ржЕржкрж╛рж░рзЗрж╢ржи рж╕ржорзНржнржм рж╣ржмрзЗ ржирж╛ (Real-time Sync)ред
            </p>
        </div>

        <!-- Common Settings -->
        <div class="card">
            <h3>ЁЯТ╡ ржкрзНрж░рж╛рж░ржорзНржнрж┐ржХ ржХрзНржпрж╛рж╢</h3>
            <div class="field"><label>ржЖржЬржХрзЗрж░ рж╢рзБрж░рзБрж░ ржХрзНржпрж╛рж╢ (рз│)</label><input type="number" id="openCash" step="0.01" min="0"></div>
            <button class="btn btn-p btn-full" onclick="setOpenCash()">ЁЯТ░ рж╕рзЗржЯ ржХрж░рзБржи</button>
            <p style="font-size:11px;color:#666;margin-top:6px">ЁЯТб ржкрзВрж░рзНржмржмрж░рзНрждрзА ржжрж┐ржирзЗрж░ ржХрзНрж▓рзЛржЬрж┐ржВ ржХрзНржпрж╛рж╢ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝</p>
        </div>
        <div class="card">
            <h3>ЁЯТ╛ ржмрзНржпрж╛ржХржЖржк ржУ рж░рж┐рж╕рзНржЯрзЛрж░</h3>
            <div class="btns">
                <button class="btn btn-s" onclick="backupData()">ЁЯТ╛ ржмрзНржпрж╛ржХржЖржк</button>
                <button class="btn btn-w" onclick="$('restoreFile').click()">ЁЯУВ рж░рж┐рж╕рзНржЯрзЛрж░</button>
                <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(event)">
            </div>
            <div id="dataInfo" class="alert alert-i" style="margin-top:10px"></div>
        </div>
        <div class="card" style="border-color:#dc3545">
            <h3 style="color:#dc3545">тЪая╕П ржмрж┐ржкржЬрзНржЬржиржХ ржЬрзЛржи</h3>
            <button class="btn btn-w btn-full" onclick="logout()" style="margin-bottom:5px">ЁЯЪк рж▓ржЧржЖржЙржЯ</button>
            <button class="btn btn-d btn-full admin-only" onclick="resetAll()">ЁЯЧСя╕П рж╕ржХрж▓ ржбрж╛ржЯрж╛ ржорзБржЫрзБржи</button>
        </div>
    </div>
</div>

<!-- ржкржгрзНржп ржоржбрж╛рж▓ -->
<div class="modal-bg" id="prodModal">
    <div class="modal">
        <h3 id="prodModalTitle">ржирждрзБржи ржкржгрзНржп <span class="x" onclick="closeModal('prodModal')">&times;</span></h3>
        <input type="hidden" id="editProdId">
        <div class="field"><label>ржирж╛ржо *</label><input type="text" id="pName"></div>
        <div class="field"><label>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ *</label>
            <select id="pCat"><option value="">ржирж┐рж░рзНржмрж╛ржЪржи</option><option>ржмрж┐ржЪрж┐</option><option>ржмрж╛ржжрж╛ржо</option><option>ржЪржирж╛ржмрзБржЯ</option><option>ржЕржирзНржпрж╛ржирзНржп</option></select>
        </div>
        <div class="row row2">
            <div class="field"><label>ржЗржЙржирж┐ржЯ *</label>
                <select id="pUnit"><option>ржХрзЗржЬрж┐</option><option>ржкрж┐рж╕</option><option>рж▓рж┐ржЯрж╛рж░</option></select>
            </div>
            <div class="field"><label>ржирзНржпрзВржирждржо рж╕рзНржЯржХ</label><input type="number" id="pMin" value="10" min="0"></div>
        </div>
        <div class="btns">
            <button class="btn btn-s" id="btnSavProd" onclick="addProduct()">тЬЕ рж╕ржВрж░ржХрзНрж╖ржг</button>
            <button class="btn btn-p" id="btnUpdProd" style="display:none" onclick="updateProduct()">ЁЯФД ржЖржкржбрзЗржЯ</button>
            <button class="btn btn-g" onclick="closeModal('prodModal')">тЭМ ржмрж╛рждрж┐рж▓</button>
        </div>
    </div>
</div>

<!-- ржнрзЗржирзНржбрж░ ржоржбрж╛рж▓ -->
<div class="modal-bg" id="vendModal">
    <div class="modal">
        <h3 id="vendModalTitle">ржирждрзБржи ржнрзЗржирзНржбрж░ <span class="x" onclick="closeModal('vendModal')">&times;</span></h3>
        <input type="hidden" id="editVendId">
        <div class="field"><label>ржирж╛ржо *</label><input type="text" id="vName"></div>
        <div class="field"><label>ржорзЛржмрж╛ржЗрж▓ *</label><input type="tel" id="vPhone"></div>
        <div class="field"><label>ржарж┐ржХрж╛ржирж╛</label><input type="text" id="vAddr"></div>
        <div class="btns">
            <button class="btn btn-s" id="btnSavVend" onclick="addVendor()">тЬЕ рж╕ржВрж░ржХрзНрж╖ржг</button>
            <button class="btn btn-p" id="btnUpdVend" style="display:none" onclick="updateVendor()">ЁЯФД ржЖржкржбрзЗржЯ</button>
            <button class="btn btn-g" onclick="closeModal('vendModal')">тЭМ ржмрж╛рждрж┐рж▓</button>
        </div>
    </div>
</div>

<script>
// ========== CONFIG & AUTH ==========
const ADMIN_PHONE = '01825616022';
const ADMIN_PASS = '486085';
const USER_PHONE = '01979807138';
const USER_PASS = '387180';

let isLoggedIn = false;
let isShopOpen = true;
let currentUser = { phone: '', role: 'admin' };

const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];
const fmt=n=>{n=parseFloat(n)||0;return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})};

function toast(msg,type='success'){
    const t=document.createElement('div');
    t.className='toast '+type;
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>{t.style.opacity='0';t.style.transition='.3s';setTimeout(()=>t.remove(),300)},2500); // Reduced wait
}

// ========== LOGIN SYSTEM ==========
function performLogin(){
    const phone = $('loginPhone').value.trim();
    const pass = $('loginPass').value;

    let role = '';
    const dbAdminPass = (DB.settings && DB.settings.adminPass) ? DB.settings.adminPass : ADMIN_PASS;
    const dbUserPass = (DB.settings && DB.settings.userPass) ? DB.settings.userPass : USER_PASS;

    if(phone === ADMIN_PHONE && pass === dbAdminPass){
        role = 'admin';
    } else if(phone === USER_PHONE && pass === dbUserPass){
        role = 'user';
    } else {
        toast('ржнрзБрж▓ ржирж╛ржорзНржмрж╛рж░ ржмрж╛ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб','error');
        return;
    }

    isLoggedIn = true;
    currentUser.phone = phone;
    currentUser.role = role;
    
    $('loginScreen').style.display = 'none';
    $('mainApp').classList.add('active');
    
    updateRoleUI();
    
    // Load Shop Status
    const savedStatus = localStorage.getItem('mainuShopStatus');
    if(savedStatus === 'closed') {
        isShopOpen = false;
    } else {
        isShopOpen = true;
    }
    updateShopUI();
    
    initApp();
}

function updateRoleUI(){
    if(currentUser.role === 'admin'){
        $('userRoleBadge').textContent = 'Admin Mode';
        $('userRoleBadge').style.color = '#fff';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    } else {
        $('userRoleBadge').textContent = 'User Mode';
        $('userRoleBadge').style.color = '#ffd700';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }
}

function logout(){
    if(confirm('ржЖржкржирж┐ ржХрж┐ рж▓ржЧржЖржЙржЯ ржХрж░рждрзЗ ржЪрж╛ржи?')){
        isLoggedIn = false;
        $('mainApp').classList.remove('active');
        $('loginScreen').style.display = 'flex';
        $('loginPhone').value = '';
        $('loginPass').value = '';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    }
}

// ========== SHOP CONTROL (REAL-TIME SYNC) ==========
function toggleShopStatus(status){
    if(currentUser.role !== 'admin'){
        toast('рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржжрзЛржХрж╛ржи ржЦрзЛрж▓рж╛/ржмржирзНржз ржХрж░рждрзЗ ржкрж╛рж░рзЗржи','error');
        return;
    }
    
    isShopOpen = status;
    // This value is checked on load or polling (simulated here by localStorage)
    localStorage.setItem('mainuShopStatus', isShopOpen ? 'open' : 'closed');
    
    updateShopUI();
    save();
    toast(status ? 'ржжрзЛржХрж╛ржи ржЦрзЛрж▓рж╛ рж╣рзЯрзЗржЫрзЗ' : 'ржжрзЛржХрж╛ржи ржмржирзНржз ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ (рж╕рж┐рж╕рзНржЯрзЗржо рж╕ржм ржХрж╛ржЬ ржмржирзНржз)', 'info');
}

function updateShopUI(){
    const badge = $('shopStatusBadge');
    const msg = $('shopClosedMsg');
    const lockedPages = document.querySelectorAll('.shop-lock-blur');
    
    if(isShopOpen){
        badge.textContent = 'ржЦрзЛрж▓рж╛';
        badge.className = 'shop-status open';
        msg.style.display = 'none';
        lockedPages.forEach(el => el.classList.remove('locked'));
        document.body.classList.remove('shop-locked');
    } else {
        badge.textContent = 'ржмржирзНржз';
        badge.className = 'shop-status closed';
        msg.style.display = 'block';
        lockedPages.forEach(el => el.classList.add('locked'));
        document.body.classList.add('shop-locked');
    }
}

// ========== PASSWORD CHANGES ==========
function changePassword(){
    if(currentUser.role !== 'admin'){
        toast('ржЕржирзБржорждрж┐ ржирзЗржЗ','error');
        return;
    }
    const curr = $('currPass').value;
    const newP = $('newPass').value;
    const validPass = DB.settings && DB.settings.adminPass ? DB.settings.adminPass : ADMIN_PASS;
    
    if(curr !== validPass){
        toast('ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржнрзБрж▓','error');
        return;
    }
    if(newP.length < 4){
        toast('ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржЕржирзНрждржд рзк рж╕ржВржЦрзНржпрж╛рж░ рж╣рждрзЗ рж╣ржмрзЗ','error');
        return;
    }
    
    if(!DB.settings) DB.settings = {};
    DB.settings.adminPass = newP;
    save();
    toast('тЬЕ ржЕрзНржпрж╛ржбржорж┐ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи рж╕ржлрж▓');
    $('currPass').value = '';
    $('newPass').value = '';
}

// ========== DATABASE (VENDOR-WISE STOCK) ==========
let DB={products:[],vendors:[],stock:[],purchases:[],sales:[],expenses:[],duePayments:[],vendorDuePayments:[],dailyCash:{},settings:{}};

function save(){
    DB.lastUpdate=new Date().toISOString();
    try{localStorage.setItem('mainuDB',JSON.stringify(DB));return true}
    catch(e){toast('рж╕ржВрж░ржХрзНрж╖ржг рждрзНрж░рзБржЯрж┐!','error');return false}
}

function load(){
    try{
        const d=localStorage.getItem('mainuDB');
        if(d){
            const p=JSON.parse(d);
            DB.products=p.products||[];
            DB.vendors=p.vendors||[];
            DB.stock=p.stock||[];
            DB.purchases=p.purchases||[];
            DB.sales=p.sales||[];
            DB.expenses=p.expenses||[];
            DB.duePayments=p.duePayments||[];
            DB.vendorDuePayments=p.vendorDuePayments||[];
            DB.dailyCash=p.dailyCash||{};
            DB.settings=p.settings||{};
            
            // MIGRATION LOGIC: If stock array is empty but old purchases exist, calculate initial stock
            if(DB.stock.length === 0 && DB.purchases.length > 0){
                migrateLegacyStock();
            }
            return true;
        }
        return false;
    }catch(e){return false}
}

// Legacy Migration function for existing data
function migrateLegacyStock(){
    const tempStockMap = {};
    DB.purchases.forEach(p => {
        const key = `${p.productId}_${p.vendorId}`;
        if(!tempStockMap[key]) tempStockMap[key] = 0;
        tempStockMap[key] += p.qty;
    });
    DB.sales.forEach(s => {
        // Assuming legacy sales don't have vendorId links perfectly, we skip legacy stock deduction to avoid negatives, 
        // or we'd need vendor mapping in legacy sales. For safety, we just aggregate purchases.
    });
    
    Object.keys(tempStockMap).forEach(key => {
        const [pid, vid] = key.split('_').map(Number);
        DB.stock.push({ id: Date.now() + Math.random(), productId: pid, vendorId: vid, qty: tempStockMap[key], avgCost: 0 });
    });
    save();
}

function initDefaults(){
    if(DB.products.length>0) return;
    const items=[
        ['ржХрж╛рж▓рж╛ржмрж┐ржЪрж┐','ржмрж┐ржЪрж┐',10],['рж╕рж╛ржжрж╛ржмрж┐ржЪрж┐','ржмрж┐ржЪрж┐',10],['ржЧрж┐рж░рж╛ржмрж┐ржЪрж┐','ржмрж┐ржЪрж┐',10],
        ['ржлрзБржЯржлрзБржЯрзЗ ржЧрж┐рж░рж╛ржмрж┐ржЪрж┐','ржмрж┐ржЪрж┐',10],['ржкрзЗрж▓ржи ржмрж┐ржЪрж┐','ржмрж┐ржЪрж┐',10],
        ['рж▓рж╛рж▓ ржкрж░рж╛рж╢','ржмрж┐ржЪрж┐',10],['рж╕рж╛ржжрж╛ ржкрж░рж╛рж╢','ржмрж┐ржЪрж┐',10],
        ['рзй ржжрж╛ржирж╛ ржмрж╛ржжрж╛ржо','ржмрж╛ржжрж╛ржо',5],['рзи ржжрж╛ржирж╛ ржмрж╛ржжрж╛ржо','ржмрж╛ржжрж╛ржо',5],
        ['рзй ржжрж╛ржирж╛ ржмрзАржЬ ржмрж╛ржжрж╛ржо','ржмрж╛ржжрж╛ржо',5],['рзи ржжрж╛ржирж╛ ржмрзАржЬ ржмрж╛ржжрж╛ржо','ржмрж╛ржжрж╛ржо',5],
        ['рж╕рзЛрж▓рждрж╛ржи ржмрж╛ржжрж╛ржо','ржмрж╛ржжрж╛ржо',5],['ржЪржирж╛ржмрзБржЯ','ржЪржирж╛ржмрзБржЯ',15]
    ];
    items.forEach((it,i)=>{
        DB.products.push({id:Date.now()+i,name:it[0],category:it[1],unit:'ржХрзЗржЬрж┐',minStock:it[2]});
    });
    save();
}

// Stock Helper Functions
function getStockEntry(productId, vendorId){
    return DB.stock.find(s => s.productId === productId && s.vendorId === vendorId);
}

function updateStock(productId, vendorId, qtyChange, costPerUnit = 0){
    let entry = getStockEntry(productId, vendorId);
    if(!entry){
        entry = { id: Date.now() + Math.random(), productId, vendorId, qty: 0, avgCost: costPerUnit };
        DB.stock.push(entry);
    }
    
    // Weighted Average Cost Logic
    const oldTotalVal = entry.qty * entry.avgCost;
    const newTotalVal = (entry.qty + qtyChange) * (qtyChange > 0 ? costPerUnit : (entry.qty + qtyChange > 0 ? ((oldTotalVal + (qtyChange * costPerUnit))/(entry.qty + qtyChange)) : 0));
    
    if(entry.qty + qtyChange > 0) {
         entry.avgCost = (oldTotalVal + (qtyChange * (qtyChange > 0 ? costPerUnit : entry.avgCost))) / (entry.qty + qtyChange);
    }
    
    entry.qty += qtyChange;
    if(entry.qty < 0) entry.qty = 0; // Safety
    
    save();
    return entry;
}

// ========== TABS & NAVIGATION ==========
document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',function(){
        if(!isLoggedIn) return;
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
        $('pg-'+this.dataset.tab).classList.add('active');
        refreshPage(this.dataset.tab);
    });
});

function refreshPage(tab){
    switch(tab){
        case 'dash':renderDash();break;
        case 'daily':initDaily();break;
        case 'due':renderDue();break;
        case 'vendue':renderVendue();break;
        case 'prod':renderProducts();break;
        case 'vend':renderVendors();break;
        case 'buy':initBuy();break;
        case 'sell':initSell();break;
        case 'stock':renderStock();break;
        case 'report':initReport();break;
        case 'set':initSettings();break;
    }
}

function openModal(id){$(id).classList.add('show');document.body.style.overflow='hidden'}
function closeModal(id){$(id).classList.remove('show');document.body.style.overflow=''}

document.querySelectorAll('.modal-bg').forEach(m=>{
    m.addEventListener('click',function(e){if(e.target===this){this.classList.remove('show');document.body.style.overflow=''}});
});

// ========== DASHBOARD & STATS ==========
function getOpeningCash(date){
    if(DB.dailyCash[date]&&DB.dailyCash[date].opening!=null)return DB.dailyCash[date].opening;
    const prev=new Date(date);prev.setDate(prev.getDate()-1);
    const ps=prev.toISOString().split('T')[0];
    if(DB.dailyCash[ps]&&DB.dailyCash[ps].closing!=null)return DB.dailyCash[ps].closing;
    return DB.settings.openingCash||0;
}

function calcDaySummary(date){
    const opening=getOpeningCash(date);
    const cashSales=DB.sales.filter(s=>s.date===date&&s.payType==='cash').reduce((a,s)=>a+s.total,0)
        +DB.sales.filter(s=>s.date===date&&s.payType==='partial').reduce((a,s)=>a+s.paid,0);
    const dueColl=DB.duePayments.filter(p=>p.date===date).reduce((a,p)=>a+p.amount,0);
    const newDue=DB.sales.filter(s=>s.date===date&&s.due>0).reduce((a,s)=>a+s.due,0);
    
    const vendorPayments=DB.vendorDuePayments.filter(p=>p.date===date).reduce((a,p)=>a+p.amount,0);
    const cashPurchases=DB.purchases.filter(p=>p.date===date&&p.payType==='cash').reduce((a,p)=>a+p.total,0)
        +DB.purchases.filter(p=>p.date===date&&p.payType==='partial').reduce((a,p)=>a+p.paid,0);
    const newVendorDue=DB.purchases.filter(p=>p.date===date&&p.due>0).reduce((a,p)=>a+p.due,0);
    
    const expenses=DB.expenses.filter(e=>e.date===date).reduce((a,e)=>a+e.amount,0);
    const closing=opening+cashSales+dueColl-cashPurchases-vendorPayments-expenses;
    
    if(!DB.dailyCash[date])DB.dailyCash[date]={};
    DB.dailyCash[date].closing=closing;
    save();
    return{opening,cashSales,dueColl,newDue,cashPurchases,vendorPayments,newVendorDue,expenses,closing};
}

function renderDash(){
    const t=today();
    const s=calcDaySummary(t);
    
    // Calculate Total stocked quantity across all vendors
    const totalStockQty = DB.stock.reduce((a,b)=>a+b.qty,0);
    
    // Low Stock Logic (Check any specific product/vendor combo is low)
    const lowItems = [];
    DB.stock.forEach(st => {
        const prod = DB.products.find(p=>p.id===st.productId);
        if(prod && st.qty <= prod.minStock) lowItems.push(`${prod.name} (V: ${getVendorName(st.vendorId)})` );
    });

    $('dashStats').innerHTML=`
        <div class="stat bg1"><h4>${DB.products.length}</h4><p>ржорзЛржЯ ржкржгрзНржп ржбрж┐ржЬрж╛ржЗржи</p></div>
        <div class="stat bg2"><h4>рз│${fmt(s.cashSales)}</h4><p>ржЖржЬржХрзЗрж░ ржЬржорж╛</p></div>
        <div class="stat bg3"><h4>рз│${fmt(s.newDue)}</h4><p>ржЖржЬржХрзЗрж░ ржмрж╛ржХрж┐</p></div>
        <div class="stat bg4"><h4>рз│${fmt(getTotalDue())}</h4><p>ржорзЛржЯ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐</p></div>
        <div class="stat bg5"><h4>рз│${fmt(getTotalVendorDue())}</h4><p>ржорзЛржЯ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐</p></div>
        <div class="stat bg6"><h4>рз│${fmt(s.closing)}</h4><p>ржмрж░рзНрждржорж╛ржи ржХрзНржпрж╛рж╢</p></div>
    `;
    
    if(lowItems.length===0){
        $('lowStock').innerHTML='<div class="alert alert-s">тЬЕ рж╕ржХрж▓ ржкржгрзНржпрзЗрж░ рж╕рзНржЯржХ ржкрж░рзНржпрж╛ржкрзНржд</div>';
    }else{
        let h='<div class="alert alert-w">тЪая╕П '+lowItems.length+'ржЯрж┐ ржкржгрзНржпрзЗрж░ рж╕рзНржЯржХ ржХржо:<br>';
        lowItems.forEach(i=>h+=`тАв <strong>${i}</strong><br>`);
        h+='</div>';
        $('lowStock').innerHTML=h;
    }
    
    const recent=DB.sales.slice(-8).reverse();
    if(recent.length===0){
        $('recentSales').innerHTML='<div class="empty"><span>ЁЯУК</span>ржХрзЛржи ржмрж┐ржХрзНрж░ржпрж╝ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржнрзЗржирзНржбрж░</th><th>ржкржгрзНржп</th><th>ржкрж░рж┐ржорж╛ржг</th><th>ржорзЛржЯ</th></tr></thead><tbody>';
        recent.forEach(s=>{
            const pr=DB.products.find(p=>p.id===s.productId);
            const vd=DB.vendors.find(v=>v.id===s.vendorId);
            h+=`<tr><td>${s.date}</td><td>${vd?vd.name:'?'}</td><td>${pr?pr.name:'?'}</td><td>${s.qty}</td><td>рз│${fmt(s.total)}</td></tr>`;
        });
        h+='</tbody></table></div>';
        $('recentSales').innerHTML=h;
    }
}

function getTotalDue(){
    const totalDueSales=DB.sales.reduce((a,s)=>a+(s.due||0),0);
    const totalPaid=DB.duePayments.reduce((a,p)=>a+p.amount,0);
    return Math.max(0,totalDueSales-totalPaid);
}

function getTotalVendorDue(){
    const totalDuePurchases=DB.purchases.reduce((a,p)=>a+(p.due||0),0);
    const totalPaid=DB.vendorDuePayments.reduce((a,p)=>a+p.amount,0);
    return Math.max(0,totalDuePurchases-totalPaid);
}

function getVendorName(id){
    const v=DB.vendors.find(x=>x.id===id);
    return v?v.name:'Unknown';
}

function getCustDue(phone){
    const dues=DB.sales.filter(s=>s.phone===phone).reduce((a,s)=>a+(s.due||0),0);
    const paid=DB.duePayments.filter(p=>p.phone===phone).reduce((a,p)=>a+p.amount,0);
    return Math.max(0,dues-paid);
}

function getVendorDue(vendorId){
    const dues=DB.purchases.filter(p=>p.vendorId===vendorId).reduce((a,p)=>a+(p.due||0),0);
    const paid=DB.vendorDuePayments.filter(p=>p.vendorId===vendorId).reduce((a,p)=>a+p.amount,0);
    return Math.max(0,dues-paid);
}

// ========== DAILY ACCOUNTING ==========
function initDaily(){
    $('dailyDate').value=today();
    renderDaily();
    $('dailyDate').onchange=renderDaily;
}

let currentEditExpId = null;

function renderDaily(){
    const d=$('dailyDate').value;
    if(!d)return;
    const s=calcDaySummary(d);
    
    $('dailySummary').innerHTML=`
        <div class="summary">
            <h4>ЁЯУК ${d} рждрж╛рж░рж┐ржЦрзЗрж░ рж╣рж┐рж╕рж╛ржм</h4>
            <div class="srow"><span>рж╢рзБрж░рзБрж░ ржХрзНржпрж╛рж╢</span><span>рз│${fmt(s.opening)}</span></div>
            <div class="srow"><span>тЮХ ржиржЧржж ржмрж┐ржХрзНрж░ржпрж╝</span><span style="color:#90EE90">рз│${fmt(s.cashSales)}</span></div>
            <div class="srow"><span>тЮХ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐ ржЖржжрж╛ржпрж╝</span><span style="color:#90EE90">рз│${fmt(s.dueColl)}</span></div>
            <div class="srow"><span>ЁЯУЭ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐</span><span style="color:#FFD700">рз│${fmt(s.newDue)}</span></div>
            <div class="srow"><span>тЮЦ ржиржЧржж ржХрзНрж░ржпрж╝</span><span style="color:#FF6B6B">рз│${fmt(s.cashPurchases)}</span></div>
            <div class="srow"><span>тЮЦ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐ ржкрж░рж┐рж╢рзЛржз</span><span style="color:#FF6B6B">рз│${fmt(s.vendorPayments)}</span></div>
            <div class="srow"><span>ЁЯУЭ ржирждрзБржи ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐</span><span style="color:#FFD700">рз│${fmt(s.newVendorDue)}</span></div>
            <div class="srow"><span>тЮЦ ржЦрж░ржЪ</span><span style="color:#FF6B6B">рз│${fmt(s.expenses)}</span></div>
            <div class="srow"><span>ЁЯТ░ ржЕржмрж╢рж┐рж╖рзНржЯ ржХрзНржпрж╛рж╢</span><span>рз│${fmt(s.closing)}</span></div>
        </div>
    `;
    
    const exps=DB.expenses.filter(e=>e.date===d);
    if(exps.length===0){
        $('expList').innerHTML='<div class="empty"><span>ЁЯТ╕</span>ржХрзЛржи ржЦрж░ржЪ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>ржзрж░ржи</th><th>ржмрж┐ржмрж░ржг</th><th>ржЯрж╛ржХрж╛</th><th></th></tr></thead><tbody>';
        exps.forEach(e=>{
            h+=`<tr><td>${e.category}</td><td>${e.desc||'-'}</td><td>рз│${fmt(e.amount)}</td>
            <td>
                <button class="btn btn-w" style="padding:4px 8px;font-size:11px;margin-right:4px" onclick="editExpense(${e.id})">тЬПя╕П</button>
                <button class="btn btn-d" style="padding:4px 8px;font-size:11px" onclick="delExpense(${e.id})">ЁЯЧСя╕П</button>
            </td></tr>`;
        });
        h+='</tbody></table></div>';
        $('expList').innerHTML=h;
    }
}

function addExpense(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    // ... (Existing Logic)
    const cat=$('expCat').value;
    const amt=parseFloat($('expAmt').value);
    const desc=$('expDesc').value.trim();
    const date=$('dailyDate').value||today();
    
    if(!cat){toast('ржзрж░ржи ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи','error');return}
    if(!amt||amt<=0){toast('рж╕ржарж┐ржХ ржЯрж╛ржХрж╛ рж▓рж┐ржЦрзБржи','error');return}
    
    DB.expenses.push({id:Date.now(),date:date,category:cat,amount:amt,desc:desc});
    save();
    toast('тЬЕ ржЦрж░ржЪ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржпрж╝рзЗржЫрзЗ');
    $('expCat').value='';$('expAmt').value='';$('expDesc').value='';
    renderDaily();
}

function editExpense(id){
    const e=DB.expenses.find(x=>x.id===id);
    if(!e)return;
    currentEditExpId=id;
    $('expCat').value=e.category;
    $('expAmt').value=e.amount;
    $('expDesc').value=e.desc||'';
    $('btnUpdExp').style.display='inline-flex';
    $('btnCanExp').style.display='inline-flex';
    document.querySelector('#pg-daily .card .btn-s').style.display='none';
}

function updateExpense(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!currentEditExpId)return;
    const cat=$('expCat').value;
    const amt=parseFloat($('expAmt').value);
    const desc=$('expDesc').value.trim();
    if(!cat||!amt){toast('рждржерзНржп рж╕ржарж┐ржХ ржиржпрж╝','error');return}
    
    const idx=DB.expenses.findIndex(x=>x.id===currentEditExpId);
    if(idx!==-1){
        DB.expenses[idx].category=cat;
        DB.expenses[idx].amount=amt;
        DB.expenses[idx].desc=desc;
        save();
        toast('тЬЕ ржЦрж░ржЪ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
    }
    cancelExpenseEdit();
}

function cancelExpenseEdit(){
    currentEditExpId=null;
    $('expCat').value='';$('expAmt').value='';$('expDesc').value='';
    $('btnUpdExp').style.display='none';
    $('btnCanExp').style.display='none';
    document.querySelector('#pg-daily .card .btn-s').style.display='inline-flex';
    renderDaily();
}

function delExpense(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?'))return;
    DB.expenses=DB.expenses.filter(e=>e.id!==id);
    save();toast('ЁЯЧСя╕П ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');renderDaily();
}

// ========== DUES (CUSTOMER & VENDOR) ==========
// Functions renderDue, showCustDue, collectDue, delDuePay remain largely the same
// Financial due tracking is independent of vendor-wise stock count, only linked to cash flow.
function renderDue(){
    $('payDate').value=today();
    const custs={};
    DB.sales.forEach(s=>{
        if(s.due>0&&s.phone){
            if(!custs[s.phone])custs[s.phone]={name:s.customer||'ржирж╛ржорж╣рзАржи',phone:s.phone};
        }
    });
    const withDue=Object.values(custs).filter(c=>getCustDue(c.phone)>0);
    const totalDue=withDue.reduce((a,c)=>a+getCustDue(c.phone),0);
    
    $('dueStats').innerHTML=`
        <div class="stat bg3"><h4>рз│${fmt(totalDue)}</h4><p>ржорзЛржЯ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐</p></div>
        <div class="stat bg2"><h4>${withDue.length}</h4><p>ржмржХрзЗржпрж╝рж╛ ржХрж╛рж╕рзНржЯржорж╛рж░</p></div>
    `;
    
    let opts='<option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option>';
    withDue.forEach(c=>opts+=`<option value="${c.phone}">${c.name} - ${c.phone}</option>`);
    $('dueCust').innerHTML=opts;
    
    if(withDue.length===0){
        $('dueList').innerHTML='<div class="alert alert-s">тЬЕ ржХрзЛржи ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>ржХрж╛рж╕рзНржЯржорж╛рж░</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржорзЛржЯ ржмрж╛ржХрж┐</th><th>ржЖржжрж╛ржпрж╝</th><th>ржмржХрзЗржпрж╝рж╛</th></tr></thead><tbody>';
        withDue.forEach(c=>{
            const totalSaleDue=DB.sales.filter(s=>s.phone===c.phone).reduce((a,s)=>a+(s.due||0),0);
            const totalPaid=DB.duePayments.filter(p=>p.phone===c.phone).reduce((a,p)=>a+p.amount,0);
            const remaining=getCustDue(c.phone);
            h+=`<tr><td>${c.name}</td><td>${c.phone}</td><td>рз│${fmt(totalSaleDue)}</td><td>рз│${fmt(totalPaid)}</td><td class="low">рз│${fmt(remaining)}</td></tr>`;
        });
        h+='</tbody></table></div>';
        $('dueList').innerHTML=h;
    }
    
    const pays=DB.duePayments.slice(-15).reverse();
    if(pays.length===0){
        $('payHistory').innerHTML='<div class="empty"><span>ЁЯТ╡</span>ржХрж╛рж╕рзНржЯржорж╛рж░ ржЖржжрж╛ржпрж╝ ржЗрждрж┐рж╣рж╛рж╕ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржХрж╛рж╕рзНржЯржорж╛рж░</th><th>ржЯрж╛ржХрж╛</th><th></th></tr></thead><tbody>';
        pays.forEach(p=>{
            const sale=DB.sales.find(s=>s.phone===p.phone);
            h+=`<tr><td>${p.date}</td><td>${sale?sale.customer:p.phone}</td><td>рз│${fmt(p.amount)}</td>
            <td><button class="btn btn-d" style="padding:4px 8px;font-size:11px" onclick="delDuePay(${p.id})">ЁЯЧСя╕П</button></td></tr>`;
        });
        h+='</tbody></table></div>';
        $('payHistory').innerHTML=h;
    }
}

function showCustDue(){
    const ph=$('dueCust').value;
    if(ph){
        const d=getCustDue(ph);
        $('custDueAmt').value=d.toFixed(2);
        $('payAmt').value=d.toFixed(2);
    }else{
        $('custDueAmt').value='';$('payAmt').value='';
    }
}

function collectDue(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const ph=$('dueCust').value;
    const amt=parseFloat($('payAmt').value);
    const date=$('payDate').value||today();
    
    if(!ph){toast('ржХрж╛рж╕рзНржЯржорж╛рж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи','error');return}
    if(!amt||amt<=0){toast('рж╕ржарж┐ржХ ржЯрж╛ржХрж╛ рж▓рж┐ржЦрзБржи','error');return}
    
    const due=getCustDue(ph);
    if(amt>due+0.01){toast('ржмржХрзЗржпрж╝рж╛рж░ ржмрзЗрж╢рж┐ ржЖржжрж╛ржпрж╝ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛','error');return}
    
    DB.duePayments.push({id:Date.now(),phone:ph,amount:amt,date:date});
    save();
    toast('тЬЕ ржХрж╛рж╕рзНржЯржорж╛рж░ ржмрж╛ржХрж┐ ржЖржжрж╛ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржпрж╝рзЗржЫрзЗ');
    $('dueCust').value='';$('custDueAmt').value='';$('payAmt').value='';
    renderDue();
}

function delDuePay(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржПржЗ ржЖржжрж╛ржпрж╝ ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? ржПрждрзЗ ржмрж╛ржХрж┐рж░ рж╣рж┐рж╕рж╛ржм ржмрзГржжрзНржзрж┐ ржкрж╛ржмрзЗред'))return;
    DB.duePayments=DB.duePayments.filter(p=>p.id!==id);
    save();
    toast('ЁЯЧСя╕П ржЖржжрж╛ржпрж╝ ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');
    renderDue();
}

// Vendor Due Logic
function renderVendue(){
    $('vendPayDate').value=today();
    const vendors=DB.vendors.filter(v=>getVendorDue(v.id)>0);
    const totalDue=vendors.reduce((a,v)=>a+getVendorDue(v.id),0);
    
    $('vendueStats').innerHTML=`
        <div class="stat bg4"><h4>рз│${fmt(totalDue)}</h4><p>ржорзЛржЯ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐</p></div>
        <div class="stat bg3"><h4>${vendors.length}</h4><p>ржмржХрзЗржпрж╝рж╛ ржнрзЗржирзНржбрж░</p></div>
    `;
    
    let opts='<option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option>';
    vendors.forEach(v=>opts+=`<option value="${v.id}">${v.name} - ${v.phone}</option>`);
    $('vendueVend').innerHTML=opts;
    
    if(vendors.length===0){
        $('vendueList').innerHTML='<div class="alert alert-s">тЬЕ ржХрзЛржи ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>ржнрзЗржирзНржбрж░</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржорзЛржЯ ржмрж╛ржХрж┐</th><th>ржкрж░рж┐рж╢рзЛржз</th><th>ржмржХрзЗржпрж╝рж╛</th></tr></thead><tbody>';
        vendors.forEach(v=>{
            const totalPurchaseDue=DB.purchases.filter(p=>p.vendorId===v.id).reduce((a,p)=>a+(p.due||0),0);
            const totalPaid=DB.vendorDuePayments.filter(p=>p.vendorId===v.id).reduce((a,p)=>a+p.amount,0);
            const remaining=getVendorDue(v.id);
            h+=`<tr><td>${v.name}</td><td>${v.phone}</td><td>рз│${fmt(totalPurchaseDue)}</td><td>рз│${fmt(totalPaid)}</td><td class="${due>0?'low':''}">рз│${fmt(remaining)}</td></tr>`;
        });
        h+='</tbody></table></div>';
        $('vendueList').innerHTML=h;
    }
    
    const pays=DB.vendorDuePayments.slice(-15).reverse();
    if(pays.length===0){
        $('vendPayHistory').innerHTML='<div class="empty"><span>ЁЯТ╡</span>ржнрзЗржирзНржбрж░ ржкрж░рж┐рж╢рзЛржз ржЗрждрж┐рж╣рж╛рж╕ ржирзЗржЗ</div>';
    }else{
        let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржнрзЗржирзНржбрж░</th><th>ржЯрж╛ржХрж╛</th><th></th></tr></thead><tbody>';
        pays.forEach(p=>{
            const vendor=DB.vendors.find(v=>v.id===p.vendorId);
            h+=`<tr><td>${p.date}</td><td>${vendor?vendor.name:'?'}</td><td>рз│${fmt(p.amount)}</td>
            <td><button class="btn btn-d" style="padding:4px 8px;font-size:11px" onclick="delVendorDuePay(${p.id})">ЁЯЧСя╕П</button></td></tr>`;
        });
        h+='</tbody></table></div>';
        $('vendPayHistory').innerHTML=h;
    }
}

function showVendDue(){
    const vid=parseInt($('vendueVend').value);
    if(vid){
        const d=getVendorDue(vid);
        $('vendDueAmt').value=d.toFixed(2);
        $('vendPayAmt').value=d.toFixed(2);
    }else{
        $('vendDueAmt').value='';$('vendPayAmt').value='';
    }
}

function payVendorDue(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const vid=parseInt($('vendueVend').value);
    const amt=parseFloat($('vendPayAmt').value);
    const date=$('vendPayDate').value||today();
    
    if(!vid){toast('ржнрзЗржирзНржбрж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи','error');return}
    if(!amt||amt<=0){toast('рж╕ржарж┐ржХ ржЯрж╛ржХрж╛ рж▓рж┐ржЦрзБржи','error');return}
    
    const due=getVendorDue(vid);
    if(amt>due+0.01){toast('ржмржХрзЗржпрж╝рж╛рж░ ржмрзЗрж╢рж┐ ржкрж░рж┐рж╢рзЛржз ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛','error');return}
    
    DB.vendorDuePayments.push({id:Date.now(),vendorId:vid,amount:amt,date:date});
    save();
    toast('тЬЕ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐ ржкрж░рж┐рж╢рзЛржз рж╕ржВрж░ржХрзНрж░ржпрж╝ рж╣ржпрж╝рзЗржЫрзЗ');
    $('vendueVend').value='';$('vendDueAmt').value='';$('vendPayAmt').value='';
    renderVendue();
}

function delVendorDuePay(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржПржЗ ржкрж░рж┐рж╢рзЛржз ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? ржПрждрзЗ ржнрзЗржирзНржбрж░ ржмрж╛ржХрж┐рж░ рж╣рж┐рж╕рж╛ржм ржмрзГржжрзНржзрж┐ ржкрж╛ржмрзЗред'))return;
    DB.vendorDuePayments=DB.vendorDuePayments.filter(p=>p.id!==id);
    save();
    toast('ЁЯЧСя╕П ржкрж░рж┐рж╢рзЛржб ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');
    renderVendue();
}

// ========== PRODUCTS & VENDORS ==========
function renderProducts(){
    const search=($('prodSearch')?.value||'').toLowerCase();
    let prods=DB.products;
    if(search)prods=prods.filter(p=>p.name.toLowerCase().includes(search)||p.category.toLowerCase().includes(search));
    
    if(prods.length===0){
        $('prodTable').innerHTML='<div class="empty"><span>ЁЯУж</span>ржХрзЛржи ржкржгрзНржп ржирзЗржЗ</div>';
        return;
    }
    
    let h='<table class="tbl"><thead><tr><th>ржирж╛ржо</th><th>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐</th><th>ржЗржЙржирж┐ржЯ</th><th>ржнрзЗржирзНржбрж░ рж╕ржВржЦрзНржпрж╛</th><th></th></tr></thead><tbody>';
    prods.forEach(p=>{
        // Count how many vendors carry this product
        const vendorCount = DB.stock.filter(s => s.productId === p.id && s.qty > 0).length;
        h+=`<tr><td>${p.name}</td><td>${p.category}</td><td>${p.unit}</td>
        <td>${vendorCount}</td>
        <td>
            <button class="btn btn-w" style="padding:3px 7px;font-size:11px" onclick="openProdModal(${p.id})">тЬПя╕П</button>
            <button class="btn btn-d" style="padding:3px 7px;font-size:11px" onclick="delProduct(${p.id})">ЁЯЧСя╕П</button>
        </td></tr>`;
    });
    h+='</tbody></table>';
    $('prodTable').innerHTML=h;
}

function openProdModal(id=null){
    const isEdit=!!id;
    $('prodModalTitle').childNodes[0].textContent=isEdit?'ржкржгрзНржп рж╕ржорзНржкрж╛ржжржирж╛':'ржирждрзБржи ржкржгрзНржп ';
    $('editProdId').value=id||'';
    
    if(isEdit){
        const p=DB.products.find(x=>x.id===id);
        $('pName').value=p.name;
        $('pCat').value=p.category;
        $('pUnit').value=p.unit;
        $('pMin').value=p.minStock;
        $('btnSavProd').style.display='none';
        $('btnUpdProd').style.display='inline-flex';
    }else{
        $('pName').value='';$('pCat').value='';$('pUnit').value='ржХрзЗржЬрж┐';$('pMin').value=10;
        $('btnSavProd').style.display='inline-flex';
        $('btnUpdProd').style.display='none';
    }
    openModal('prodModal');
}

function addProduct(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const name=$('pName').value.trim();
    const cat=$('pCat').value;
    const unit=$('pUnit').value;
    const min=parseInt($('pMin').value)||10;
    
    if(!name){toast('ржкржгрзНржпрзЗрж░ ржирж╛ржо ржжрж┐ржи','error');return}
    if(!cat){toast('ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи','error');return}
    if(DB.products.some(p=>p.name.toLowerCase()===name.toLowerCase())){toast('ржПржЗ ржкржгрзНржп ржЖржЫрзЗ','error');return}
    
    DB.products.push({id:Date.now(),name,category:cat,unit,minStock:min});
    save();
    toast('тЬЕ ржкржгрзНржп ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗ');
    closeModal('prodModal');renderProducts();
}

function updateProduct(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const id=parseInt($('editProdId').value);
    const name=$('pName').value.trim();
    const cat=$('pCat').value;
    const unit=$('pUnit').value;
    const min=parseInt($('pMin').value)||10;
    
    if(!name||!cat){toast('ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рждржерзНржп ржжрж┐ржи','error');return}
    
    const idx=DB.products.findIndex(p=>p.id===id);
    if(idx!==-1){
        DB.products[idx].name=name;
        DB.products[idx].category=cat;
        DB.products[idx].unit=unit;
        DB.products[idx].minStock=min;
        save();
        toast('тЬЕ ржкржгрзНржп ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
    }
    closeModal('prodModal');renderProducts();
}

function delProduct(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржкржгрзНржпржЯрж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?'))return;
    DB.products=DB.products.filter(p=>p.id!==id);
    // Also remove associated stock entries
    DB.stock = DB.stock.filter(s => s.productId !== id);
    save();toast('ЁЯЧСя╕П ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');renderProducts();
}

function renderVendors(){
    if(DB.vendors.length===0){
        $('vendTable').innerHTML='<div class="empty"><span>ЁЯСд</span>ржХрзЛржи ржнрзЗржирзНржбрж░ ржирзЗржЗ</div>';
        return;
    }
    let h='<table class="tbl"><thead><tr><th>ржирж╛ржо</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржарж┐ржХрж╛ржирж╛</th><th>ржорзЛржЯ ржХрзНрж░ржпрж╝</th><th>ржмрж╛ржХрж┐</th><th></th></tr></thead><tbody>';
    DB.vendors.forEach(v=>{
        const tp=DB.purchases.filter(p=>p.vendorId===v.id).reduce((a,p)=>a+p.total,0);
        const due=getVendorDue(v.id);
        h+=`<tr><td>${v.name}</td><td>${v.phone}</td><td>${v.address||'-'}</td><td>рз│${fmt(tp)}</td>
        <td class="${due>0?'low':''}">рз│${fmt(due)}</td>
        <td>
            <button class="btn btn-w" style="padding:3px 7px;font-size:11px" onclick="openVendModal(${v.id})">тЬПя╕П</button>
            <button class="btn btn-d" style="padding:3px 7px;font-size:11px" onclick="delVendor(${v.id})">ЁЯЧСя╕П</button>
        </td></tr>`;
    });
    h+='</tbody></table>';
    $('vendTable').innerHTML=h;
}

function openVendModal(id=null){
    const isEdit=!!id;
    $('vendModalTitle').childNodes[0].textContent=isEdit?'ржнрзЗржирзНржбрж░ рж╕ржорзНржкрж╛ржжржирж╛':'ржирждрзБржи ржнрзЗржирзНржбрж░ ';
    $('editVendId').value=id||'';
    
    if(isEdit){
        const v=DB.vendors.find(x=>x.id===id);
        $('vName').value=v.name;
        $('vPhone').value=v.phone;
        $('vAddr').value=v.address||'';
        $('btnSavVend').style.display='none';
        $('btnUpdVend').style.display='inline-flex';
    }else{
        $('vName').value='';$('vPhone').value='';$('vAddr').value='';
        $('btnSavVend').style.display='inline-flex';
       $('btnUpdVend').style.display='none';
    }
    openModal('vendModal');
}

function addVendor(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const name=$('vName').value.trim();
    const phone=$('vPhone').value.trim();
    const addr=$('vAddr').value.trim();
    
    if(!name){toast('ржнрзЗржирзНржбрж░рзЗрж░ ржирж╛ржо ржжрж┐ржи','error');return}
    if(!phone){toast('ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░ ржжрж┐ржи','error');return}
    if(DB.vendors.some(v=>v.phone===phone)){toast('ржПржЗ ржиржорзНржмрж░рзЗ ржнрзЗржирзНржбрж░ ржЖржЫрзЗ','error');return}
    
    DB.vendors.push({id:Date.now(),name,phone,address:addr});
    save();
    toast('тЬЕ ржнрзЗржирзНржбрж░ ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗ');
    closeModal('vendModal');renderVendors();
}

function updateVendor(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const id=parseInt($('editVendId').value);
    const name=$('vName').value.trim();
    const phone=$('vPhone').value.trim();
    const addr=$('vAddr').value.trim();
    
    if(!name||!phone){toast('ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рждржерзНржп ржжрж┐ржи','error');return}
    
    const idx=DB.vendors.findIndex(v=>v.id===id);
    if(idx!==-1){
        DB.vendors[idx].name=name;
        DB.vendors[idx].phone=phone;
        DB.vendors[idx].address=addr;
        save();
        toast('тЬЕ ржнрзЗржирзНржбрж░ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
    }
    closeModal('vendModal');renderVendors();
}

function delVendor(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржнрзЗржирзНржбрж░ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? рж╕ржВрж╢рзНрж▓рж┐рж╖рзНржЯ рж╕рзНржЯржХ рж░рзЗржХрж░рзНржбржУ ржорзБржЫрзЗ ржпрж╛ржмрзЗред'))return;
    DB.vendors=DB.vendors.filter(v=>v.id!==id);
    DB.stock=DB.stock.filter(s=>s.vendorId!==id);
    save();toast('ЁЯЧСя╕П ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');renderVendors();
}

// ========== PURCHASE ==========
function initBuy(){
    resetBuyForm();
    renderBuyHistory();
}

function resetBuyForm(){
    $('buyFrmTitle').textContent='ЁЯЫТ ржирждрзБржи ржХрзНрж░ржпрж╝';
    $('editBuyId').value='';
    $('buyDate').value=today();
    
    let vo='<option value="">ржнрзЗржирзНржбрж░ ржирж┐рж░рзНржмрж╛ржЪржи</option>';
    DB.vendors.forEach(v=>vo+=`<option value="${v.id}">${v.name}</option>`);
    $('buyVend').innerHTML=vo;
    
    let po='<option value="">ржкржгрзНржп ржирж┐рж░рзНржмрж╛ржЪржи</option>';
    DB.products.forEach(p=>po+=`<option value="${p.id}">${p.name} (${p.unit})</option>`);
    $('buyProd').innerHTML=po;
    
    $('buyQty').value='';$('buyPrice').value='';$('buyTotal').value='';$('buyNote').value='';
    $('buyPaid').value='';$('buyDue').value='';
    $('buyPartialDiv').style.display='none';
    document.querySelector('input[name="buyPayType"][value="cash"]').checked=true;
    
    $('btnSaveBuy').style.display='inline-flex';
    $('btnUpdBuy').style.display='none';
    $('btnCanBuy').style.display='none';
}

function calcBuy(){
    const q=parseFloat($('buyQty').value)||0;
    const p=parseFloat($('buyPrice').value)||0;
    $('buyTotal').value=(q*p).toFixed(2);
    calcBuyPartial();
}

function toggleBuyPartial(){
    const type=document.querySelector('input[name="buyPayType"]:checked').value;
    $('buyPartialDiv').style.display=type==='partial'?'block':'none';
    if(type==='partial'){
        const total=parseFloat($('buyTotal').value)||0;
        $('buyPaid').value=(total/2).toFixed(2);
        calcBuyPartial();
    }
}

function calcBuyPartial(){
    const total=parseFloat($('buyTotal').value)||0;
    const paid=parseFloat($('buyPaid').value)||0;
    $('buyDue').value=(total-paid).toFixed(2);
}

function addPurchase(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const date=$('buyDate').value;
    const vendorId=parseInt($('buyVend').value);
    const productId=parseInt($('buyProd').value);
    const qty=parseFloat($('buyQty').value);
    const price=parseFloat($('buyPrice').value);
    const total=parseFloat($('buyTotal').value);
    const payType=document.querySelector('input[name="buyPayType"]:checked').value;
    const note=$('buyNote').value.trim();
    
    if(!date||!vendorId||!productId||!qty||!price){toast('рж╕ржХрж▓ рждржерзНржп ржжрж┐ржи','error');return}
    
    let paid=0,due=0;
    if(payType==='cash'){paid=total;due=0}
    else if(payType==='due'){paid=0;due=total}
    else{
        paid=parseFloat($('buyPaid').value)||0;
        due=total-paid;
        if(paid>total){toast('ржЬржорж╛ ржорзЛржЯрзЗрж░ ржмрзЗрж╢рж┐ рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛','error');return}
        if(paid<0){toast('ржЬржорж╛ ржЛржгрж╛рждрзНржоржХ рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛','error');return}
    }
    
    // Update Vendor-Wise Stock
    updateStock(productId, vendorId, qty, price);
    
    DB.purchases.push({id:Date.now(),date,vendorId,productId,qty,price,total,payType,paid,due,note});
    save();toast('тЬЕ ржХрзНрж░ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржпрж╝рзЗржЫрзЗ');
    resetBuyForm();renderBuyHistory();
}

function editPurchase(id){
    const b=DB.purchases.find(x=>x.id===id);
    if(!b)return;
    
    $('editBuyId').value=id;
    $('buyFrmTitle').textContent='ЁЯФД ржХрзНрж░ржпрж╝ рж╕ржорзНржкрж╛ржжржирж╛';
    $('buyDate').value=b.date;
    $('buyVend').value=b.vendorId;
    $('buyProd').value=b.productId;
    $('buyQty').value=b.qty;
    $('buyPrice').value=b.price;
    $('buyNote').value=b.note||'';
    
    const radios=document.getElementsByName('buyPayType');
    for(let r of radios){
        if(r.value===b.payType)r.checked=true;
    }
    toggleBuyPartial();
    if(b.payType==='partial'){
        $('buyPaid').value=b.paid;
        calcBuyPartial();
    }
    
    calcBuy();
    
    $('btnSaveBuy').style.display='none';
    $('btnUpdBuy').style.display='inline-flex';
    $('btnCanBuy').style.display='inline-flex';
}

function updatePurchase(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const id=parseInt($('editBuyId').value);
    if(!id)return;
    const oldData=DB.purchases.find(b=>b.id===id);
    const newQty=parseFloat($('buyQty').value);
    const newPrice=parseFloat($('buyPrice').value);
    const payType=document.querySelector('input[name="buyPayType"]:checked').value;
    
    if(!oldData||!newQty||!newPrice){toast('рждржерзНржп рж╕ржарж┐ржХ ржиржпрж╝','error');return}
    
    // REVERT OLD STOCK
    // Reverse Stock logic is complex with weighted averages. For simplicity in this edit, 
    // we adjust the stock net change.
    const stockDiff = newQty - oldData.qty;
    
    // Update Stock with corrected values (simplified logic)
    updateStock(oldData.productId, oldData.vendorId, stockDiff, newPrice);
    
    let paid=0,due=0;
    if(payType==='cash'){paid=parseFloat($('buyTotal').value);due=0}
    else if(payType==='due'){paid=0;due=parseFloat($('buyTotal').value)}
    else{
        paid=parseFloat($('buyPaid').value)||0;
        due=parseFloat($('buyTotal').value)-paid;
    }
    
    const idx=DB.purchases.findIndex(b=>b.id===id);
    if(idx!==-1){
        DB.purchases[idx].date=$('buyDate').value;
        DB.purchases[idx].vendorId=parseInt($('buyVend').value);
        DB.purchases[idx].productId=parseInt($('buyProd').value);
        DB.purchases[idx].qty=newQty;
        DB.purchases[idx].price=newPrice;
        DB.purchases[idx].total=parseFloat($('buyTotal').value);
        DB.purchases[idx].payType=payType;
        DB.purchases[idx].paid=paid;
        DB.purchases[idx].due=due;
        DB.purchases[idx].note=$('buyNote').value.trim();
        save();
        toast('тЬЕ ржХрзНрж░ржпрж╝ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
    }
    resetBuyForm();renderBuyHistory();
}

function delPurchase(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржХрзНрж░ржпрж╝ ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? рж╕рзНржЯржХ ржХржорзЗ ржпрж╛ржмрзЗред'))return;
    const b=DB.purchases.find(x=>x.id===id);
    if(b){
        // Decrease stock
        updateStock(b.productId, b.vendorId, -b.qty, b.price);
    }
    DB.purchases=DB.purchases.filter(b=>b.id!==id);
    save();toast('ЁЯЧСя╕П ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');renderBuyHistory();
}

function renderBuyHistory(){
    const buys=DB.purchases.slice(-20).reverse();
    if(buys.length===0){
        $('buyList').innerHTML='<div class="empty"><span>ЁЯЫТ</span>ржХрзЛржи ржХрзНрж░ржпрж╝ ржирзЗржЗ</div>';
        return;
    }
    let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржнрзЗржирзНржбрж░</th><th>ржкржгрзНржп</th><th>ржкрж░рж┐ржорж╛ржг</th><th>ржжрж░</th><th>ржорзЛржЯ</th><th>ржЯрж╛ржЗржк</th><th></th></tr></thead><tbody>';
    buys.forEach(b=>{
        const v=DB.vendors.find(x=>x.id===b.vendorId);
        const p=DB.products.find(x=>x.id===b.productId);
        h+=`<tr><td>${b.date}</td><td>${v?v.name:'?'}</td><td>${p?p.name:'?'}</td><td>${b.qty}</td><td>рз│${fmt(b.price)}</td><td>рз│${fmt(b.total)}</td>
        <td><span class="badge ${b.payType==='cash'?'badge-g':b.payType==='due'?'badge-r':'badge-y'}">${b.payType==='cash'?'ржиржЧржж':b.payType==='due'?'ржмрж╛ржХрж┐':'ржЖржВрж╢рж┐ржХ'}</span></td>
        <td>
            <button class="btn btn-w" style="padding:4px 8px;font-size:11px;margin-right:4px" onclick="editPurchase(${b.id})">тЬПя╕П</button>
            <button class="btn btn-d" style="padding:4px 8px;font-size:11px" onclick="delPurchase(${b.id})">ЁЯЧСя╕П</button>
        </td></tr>`;
    });
    h+='</tbody></table></div>';
    $('buyList').innerHTML=h;
}

// ========== SALES (UPDATED LOGIC) ==========
function initSell(){
    resetSellForm();
    
    // Populate Vendor Dropdown
    let vo='<option value="">ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option>';
    DB.vendors.forEach(v=>vo+=`<option value="${v.id}">${v.name}</option>`);
    $('sellVendor').innerHTML=vo;
    
    updateSellProductList();
    renderSellHistory();
}

function resetSellForm(){
    $('sellFrmTitle').textContent='ЁЯТ░ ржирждрзБржи ржмрж┐ржХрзНрж░ржпрж╝';
    $('editSellId').value='';
    $('sellDate').value=today();
    $('sellCust').value='';$('sellPhone').value='';
    $('sellVendor').value=''; 
    updateSellProductList();
    $('sellQty').value='';$('sellPrice').value='';$('sellTotal').value='';
    $('stockInfo').style.display='none';
    $('partialDiv').style.display='none';
    document.querySelector('input[name="payType"][value="cash"]').checked=true;
    $('sellPaid').value='';$('sellDue').value='';
    
    $('btnSaveSell').style.display='inline-flex';
    $('btnUpdSell').style.display='none';
    $('btnCanSell').style.display='none';
}

function updateSellProductList(){
    const vendorId = parseInt($('sellVendor').value);
    const prodSelect = $('sellProd');
    
    if(!vendorId){
        prodSelect.innerHTML = '<option value="">ржкрзНрж░ржержорзЗ ржнрзЗржирзНржбрж░ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option>';
        return;
    }
    
    // Find products that have stock for this vendor
    let po='<option value="">ржкржгрзНржп ржирж┐рж░рзНржмрж╛ржЪржи</option>';
    let availableProds = false;
    
    DB.stock.forEach(s => {
        if(s.vendorId === vendorId && s.qty > 0){
            const p=DB.products.find(x=>x.id===s.productId);
            if(p){
                availableProds = true;
                po+=`<option value="${p.id}">${p.name} (рж╕рзНржЯржХ: ${s.qty} ${p.unit})</option>`;
            }
        }
    });
    
    if(!availableProds) po = '<option value="">ржПржЗ ржнрзЗржирзНржбрж░рзЗрж░ ржХрзЛржирзЛ рж╕рзНржЯржХ ржирзЗржЗ</option>';
    
    prodSelect.innerHTML = po;
    $('stockInfo').style.display='none';
}

function showSellStock(){
    const vid = parseInt($('sellVendor').value);
    const pid=parseInt($('sellProd').value);
    if(!pid || !vid){$('stockInfo').style.display='none';return}
    
    const stockEntry = getStockEntry(pid, vid);
    const prod = DB.products.find(p=>p.id===pid);
    
    if(stockEntry && prod){
        $('stockInfo').style.display='block';
        $('stockInfo').innerHTML=`ЁЯУж <strong>${prod.name}</strong>: рж╕рзНржЯржХ ${stockEntry.qty} ${prod.unit} | ржЧржбрж╝ ржХрзНрж░ржпрж╝ржорзВрж▓рзНржп: рз│${fmt(stockEntry.avgCost)}`;
        $('stockInfo').className=stockEntry.qty<=prod.minStock?'alert alert-w':'alert alert-i';
        
        // Pre-fill price with a suggested margin (e.g., 20%)
        if(!$('sellPrice').value || $('sellPrice').value == 0){
            $('sellPrice').value = (stockEntry.avgCost * 1.2).toFixed(2);
        }
    }
}

function calcSell(){
    const q=parseFloat($('sellQty').value)||0;
    const p=parseFloat($('sellPrice').value)||0;
    const total=q*p;
    $('sellTotal').value=total.toFixed(2);
    calcPartial();
}

function calcPartial(){
    const total=parseFloat($('sellTotal').value)||0;
    const paid=parseFloat($('sellPaid').value)||0;
    $('sellDue').value=(total-paid).toFixed(2);
}

function togglePartial(){
    const type=document.querySelector('input[name="payType"]:checked').value;
    $('partialDiv').style.display=type==='partial'?'block':'none';
    if(type==='partial'){
        const total=parseFloat($('sellTotal').value)||0;
        $('sellPaid').value=(total/2).toFixed(2);
        calcPartial();
    }
}

function addSale(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const date=$('sellDate').value;
    const customer=$('sellCust').value.trim()||'ржирж╛ржорж╣рзАржи';
    const phone=$('sellPhone').value.trim()||'N/A';
    const vendorId=parseInt($('sellVendor').value);
    const productId=parseInt($('sellProd').value);
    const qty=parseFloat($('sellQty').value);
    const price=parseFloat($('sellPrice').value);
    const total=parseFloat($('sellTotal').value);
    const payType=document.querySelector('input[name="payType"]:checked').value;
    
    if(!date||!vendorId||!productId||!qty||!price){toast('рж╕ржХрж▓ рждржерзНржп ржжрж┐ржи','error');return}
    
    // Check specific vendor stock
    const stockEntry = getStockEntry(productId, vendorId);
    if(!stockEntry || stockEntry.stock < qty){toast(`рж╕рзНржЯржХ ржЕржкрж░рзНржпрж╛ржкрзНржд! ржорж╛рждрзНрж░ ${stockEntry?stockEntry.qty:0} ржЖржЫрзЗ (ржнрзЗржирзНржбрж░: ${getVendorName(vendorId)})`,'error');return}
    
    let paid=0,due=0;
    if(payType==='cash'){paid=total;due=0}
    else if(payType==='due'){paid=0;due=total}
    else{
        paid=parseFloat($('sellPaid').value)||0;
        due=total-paid;
        if(paid>total){toast('ржЬржорж╛ ржорзЛржЯрзЗрж░ ржмрзЗрж╢рж┐ рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛','error');return}
        if(paid<0){toast('ржЬржорж╛ ржЛржгрж╛рждрзНржоржХ рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛','error');return}
    }
    
    // Deduct Stock from specific Vendor entry
    updateStock(productId, vendorId, -qty, price);
    
    // Calculate Profit based on cost
    const costPrice = stockEntry.avgCost;
    const profit = (price - costPrice) * qty;
    
    DB.sales.push({id:Date.now(),date,customer,phone,vendorId,productId,qty,price,total,payType,paid,due,profit});
    save();toast('тЬЕ ржмрж┐ржХрзНрж░ржпрж╝ рж╕ржВрж░ржХрзНрж╖ржг рж╣ржпрж╝рзЗржЫрзЗ');
    resetSellForm();renderSellHistory();
}

function editSale(id){
    const s=DB.sales.find(x=>x.id===id);
    if(!s)return;
    
    $('editSellId').value=id;
    $('sellFrmTitle').textContent='ЁЯФД ржмрж┐ржХрзНрж░ржпрж╝ рж╕ржорзНржкрж╛ржжржирж╛';
    $('sellDate').value=s.date;
    $('sellCust').value=s.customer;
    $('sellPhone').value=s.phone;
    
    // Set Vendor
    $('sellVendor').value = s.vendorId;
    updateSellProductList();
    
    $('sellProd').value=s.productId;
    showSellStock();
    
    $('sellQty').value=s.qty;
    $('sellPrice').value=s.price;
    calcSell();
    
    const radios=document.getElementsByName('payType');
    for(let r of radios){
        if(r.value===s.payType)r.checked=true;
    }
    togglePartial();
    if(s.payType==='partial'){
        $('sellPaid').value=s.paid;
        calcPartial();
    }
    
    $('btnSaveSell').style.display='none';
    $('btnUpdSell').style.display='inline-flex';
    $('btnCanSell').style.display='inline-flex';
}

function updateSale(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const id=parseInt($('editSellId').value);
    if(!id)return;
    const oldData=DB.sales.find(s=>s.id===id);
    const newQty=parseFloat($('sellQty').value);
    const total=parseFloat($('sellTotal').value);
    const payType=document.querySelector('input[name="payType"]:checked').value;
    const newVendorId = parseInt($('sellVendor').value);
    const newProductId = parseInt($('sellProd').value);
    const newPrice = parseFloat($('sellPrice').value);
    
    if(!oldData||!newQty){toast('рждржерзНржп рж╕ржарж┐ржХ ржиржпрж╝','error');return}
    
    // Handle Stock Change
    // 1. Revert Old Stock (Add back old qty to old vendor)
    updateStock(oldData.productId, oldData.vendorId, oldData.qty, 0); // Cost doesn't matter for revert strictly if avgCost handled well, but 0 is safe
    
    // 2. Deduct New Stock (Subtract new qty from new vendor)
    const targetStock = getStockEntry(newProductId, newVendorId);
    if(!targetStock || targetStock.qty < newQty){
        toast('ржирждрзБржи рж╕рж┐рж▓рзЗржХрж╢ржирзЗ ржкрж░рзНржпрж╛ржкрзНржд рж╕рзНржЯржХ ржирзЗржЗ!','error');
        // Rollback the revert
        updateStock(oldData.productId, oldData.vendorId, -oldData.qty, 0);
        return;
    }
    updateStock(newProductId, newVendorId, -newQty, newPrice);
    
    let paid=0,due=0;
    if(payType==='cash'){paid=total;due=0}
    else if(payType==='due'){paid=0;due=total}
    else{
        paid=parseFloat($('sellPaid').value)||0;
        due=total-paid;
    }
    
    const profit = (newPrice - (targetStock.avgCost + (oldData.qty>0 ? 0 : 0))) * newQty; // Simplified profit calc based on current cost
    
    const idx=DB.sales.findIndex(s=>s.id===id);
    if(idx!==-1){
        DB.sales[idx].date=$('sellDate').value;
        DB.sales[idx].customer=$('sellCust').value.trim()||'ржирж╛ржорж╣рзАржи';
        DB.sales[idx].phone=$('sellPhone').value.trim()||'N/A';
        DB.sales[idx].vendorId=newVendorId;
        DB.sales[idx].productId=newProductId;
        DB.sales[idx].qty=newQty;
        DB.sales[idx].price=newPrice;
        DB.sales[idx].total=total;
        DB.sales[idx].payType=payType;
        DB.sales[idx].paid=paid;
        DB.sales[idx].due=due;
        DB.sales[idx].profit=profit; // Recalculate profit properly if needed
        save();
        toast('тЬЕ ржмрж┐ржХрзНрж░ржпрж╝ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
    }
    resetSellForm();renderSellHistory();
}

function delSale(id){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    if(!confirm('ржмрж┐ржХрзНрж░ржпрж╝ ржПржирзНржЯрзНрж░рж┐ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? рж╕рзНржЯржХ ржлрзЗрж░ржд ржЖрж╕ржмрзЗред'))return;
    const s=DB.sales.find(x=>x.id===id);
    if(s){
        // Return stock to the specific vendor
        updateStock(s.productId, s.vendorId, s.qty, 0);
    }
    DB.sales=DB.sales.filter(s=>s.id!==id);
    save();toast('ЁЯЧСя╕П ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');renderSellHistory();
}

function renderSellHistory(){
    const sales=DB.sales.slice(-20).reverse();
    if(sales.length===0){
        $('sellList').innerHTML='<div class="empty"><span>ЁЯТ░</span>ржХрзЛржи ржмрж┐ржХрзНрж░ржпрж╝ ржирзЗржЗ</div>';
        return;
    }
    let h='<div class="tbl-wrap"><table class="tbl"><thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржХрж╛рж╕рзНржЯржорж╛рж░</th><th>ржнрзЗржирзНржбрж░</th><th>ржкржгрзНржп</th><th>ржкрж░рж┐ржорж╛ржг</th><th>ржорзЛржЯ</th><th>ржЯрж╛ржЗржк</th><th></th></tr></thead><tbody>';
    sales.forEach(s=>{
        const p=DB.products.find(x=>x.id===s.productId);
        const v=DB.vendors.find(x=>x.id===s.vendorId);
        h+=`<tr><td>${s.date}</td><td>${s.customer}</td><td>${v?v.name:'?'}</td><td>${p?p.name:'?'}</td><td>${s.qty}</td><td>рз│${fmt(s.total)}</td>
        <td><span class="badge ${s.payType==='cash'?'badge-g':s.payType==='due'?'badge-r':'badge-y'}">${s.payType==='cash'?'ржиржЧржж':s.payType==='due'?'ржмрж╛ржХрж┐':'ржЖржВрж╢рж┐ржХ'}</span></td>
        <td>
            <button class="btn btn-w" style="padding:4px 8px;font-size:11px;margin-right:4px" onclick="editSale(${s.id})">тЬПя╕П</button>
            <button class="btn btn-d" style="padding:4px 8px;font-size:11px" onclick="delSale(${s.id})">ЁЯЧСя╕П</button>
        </td></tr>`;
    });
    h+='</tbody></table></div>';
    $('sellList').innerHTML=h;
}

// ========== STOCK & REPORTING ==========
function renderStock(){
    const search=($('stockSearch')?.value||'').toLowerCase();
    const vendFilter = parseInt($('stockVendFilter').value);
    
    let stockList = DB.stock;
    
    // Filter by Vendor
    if(vendFilter){
        stockList = stockList.filter(s => s.vendorId === vendFilter);
    }
    
    // Filter by Search (via Product Name)
    let filteredProds = DB.products;
    if(search) filteredProds = filteredProds.filter(p=>p.name.toLowerCase().includes(search)||p.category.toLowerCase().includes(search));
    
    // Join
    stockList = stockList.filter(s => filteredProds.some(p=>p.id===s.productId));
    
    if(stockList.length===0){
        $('stockTable').innerHTML='<div class="empty"><span>ЁЯУЛ</span>ржХрзЛржи рж╕рзНржЯржХ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐</div>';
        return;
    }
    
    // Populate Vendor Filter Options if empty
    if($('stockVendFilter').options.length <= 1){
        let vo='<option value="">рж╕ржХрж▓ ржнрзЗржирзНржбрж░</option>';
        DB.vendors.forEach(v=>vo+=`<option value="${v.id}">${v.name}</option>`);
        $('stockVendFilter').innerHTML=vo;
    }
    
    let h='<table class="tbl"><thead><tr><th>ржкржгрзНржп</th><th>ржнрзЗржирзНржбрж░</th><th>рж╕рзНржЯржХ</th><th>ржЗржЙржирж┐ржЯ</th><th>ржЧрзЬ ржжрж░</th><th>ржорзВрж▓рзНржп</th><th>рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕</th></tr></thead><tbody>';
    
    stockList.forEach(s=>{
        const p=DB.products.find(x=>x.id===s.productId);
        const v=DB.vendors.find(x=>x.id===s.vendorId);
        if(!p || !v) return;
        
        const isLow = s.qty <= p.minStock;
        const st=isLow?'<span class="badge badge-r">тЪая╕П ржХржо</span>':'<span class="badge badge-g">тЬЕ ржнрж╛рж▓</span>';
        
        h+=`<tr><td>${p.name}</td><td>${v.name}</td><td class="${isLow?'low':''}">${s.qty}</td>
        <td>${p.unit}</td>
        <td>рз│${fmt(s.avgCost)}</td>
        <td>рз│${fmt(s.qty * s.avgCost)}</td>
        <td>${st}</td></tr>`;
    });
    h+='</tbody></table>';
    $('stockTable').innerHTML=h;
}

function exportStockCSV(){
    let csv='\uFEFF'; 
    csv+='ржкржгрзНржпрзЗрж░ ржирж╛ржо,ржнрзЗржирзНржбрж░,ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ,ржЗржЙржирж┐ржЯ,ржорзЛржЯ ржорзВрж▓рзНржп (ржХрзНрж░ржпрж╝)\n';
    DB.stock.forEach(s=>{
        const p=DB.products.find(x=>x.id===s.productId);
        const v=DB.vendors.find(x=>x.id===s.vendorId);
        if(p && v){
            csv+=`${p.name},${v.name},${s.qty},${p.unit},${(s.qty*s.avgCost).toFixed(2)}\n`;
        }
    });
    downloadFile(csv,'vendor_stock_report_'+today()+'.csv','text/csv');
    toast('тЬЕ CSV ржбрж╛ржЙржирж▓рзЛржб рж╣ржпрж╝рзЗржЫрзЗ');
}

function exportFullCSV(){
    let csv='\uFEFF';
    csv+='=== ржмрж┐ржХрзНрж░ржпрж╝ рж░рж┐ржкрзЛрж░рзНржЯ ===\n';
    csv+='рждрж╛рж░рж┐ржЦ,ржХрж╛рж╕рзНржЯржорж╛рж░,ржорзЛржмрж╛ржЗрж▓,ржнрзЗржирзНржбрж░,ржкржгрзНржп,ржкрж░рж┐ржорж╛ржг,ржжрж░,ржорзЛржЯ,ржкрзЗржорзЗржирзНржЯ,ржЬржорж╛,ржмрж╛ржХрж┐,рж▓рж╛ржн\n';
    const sd=$('repStart').value;const ed=$('repEnd').value;
    let sales=DB.sales;
    if(sd&&ed)sales=sales.filter(s=>s.date>=sd&&s.date<=ed);
    sales.forEach(s=>{
        const p=DB.products.find(x=>x.id===s.productId);
        const v=DB.vendors.find(x=>x.id===s.vendorId);
        csv+=`${s.date},${s.customer},${s.phone},${v?v.name:'?'},${p?p.name:'?'},${s.qty},${s.price},${s.total},${s.payType},${s.paid},${s.due},${s.profit}\n`;
    });
    
    csv+='\n=== ржХрзНрж░ржпрж╝ рж░рж┐ржкрзЛрж░рзНржЯ ===\n';
    csv+='рждрж╛рж░рж┐ржЦ,ржнрзЗржирзНржбрж░,ржкржгрзНржп,ржкрж░рж┐ржорж╛ржг,ржжрж░,ржорзЛржЯ,ржкрзЗржорзЗржирзНржЯ,ржЬржорж╛,ржмрж╛ржХрж┐\n';
    let buys=DB.purchases;
    if(sd&&ed)buys=buys.filter(b=>b.date>=sd&&b.date<=ed);
    buys.forEach(b=>{
        const v=DB.vendors.find(x=>x.id===b.vendorId);
        const p=DB.products.find(x=>x.id===b.productId);
        csv+=`${b.date},${v?v.name:'?'},${p?p.name:'?'},${b.qty},${b.price},${b.total},${b.payType},${b.paid},${b.due}\n`;
    });
    
    csv+='\n=== ржЦрж░ржЪ рж░рж┐ржкрзЛрж░рзНржЯ ===\n';
    csv+='рждрж╛рж░рж┐ржЦ,ржзрж░ржи,ржмрж┐ржмрж░ржг,ржЯрж╛ржХрж╛\n';
    let exps=DB.expenses;
    if(sd&&ed)exps=exps.filter(e=>e.date>=sd&&e.date<=ed);
    exps.forEach(e=>{
        csv+=`${e.date},${e.category},${e.desc||''},${e.amount}\n`;
    });
    
    downloadFile(csv,'full_report_'+today()+'.csv','text/csv');
    toast('тЬЕ рж╕ржорзНржкрзВрж░рзНржг CSV ржбрж╛ржЙржирж▓рзЛржб рж╣ржпрж╝рзЗржЫрзЗ');
}

function downloadFile(content,filename,type){
    const blob=new Blob([content],{type:type+';charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printStock(){
    const w=window.open('','_blank');
    let h=`<!DOCTYPE html><html><head><title>рж╕рзНржЯржХ рж░рж┐ржкрзЛрж░рзНржЯ</title>
    <style>body{font-family:Arial;padding:20px}h1{color:#667eea;text-align:center}
    table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#667eea;color:#fff}.low{color:red;font-weight:bold}</style></head><body>
    <h1>ЁЯПк ржорзЗрж╕рж╛рж░рзНрж╕ ржорж╛ржИржирзБ ржПржирзНржЯрж╛рж░ржкрзНрж░рж╛ржЗржЬ</h1><h2 style="text-align:center">рж╕рзНржЯржХ рж░рж┐ржкрзЛрж░рзНржЯ - ${today()}</h2>
    <table><thead><tr><th>ржкржгрзНржп</th><th>ржнрзЗржирзНржбрж░</th><th>рж╕рзНржЯржХ</th><th>ржЗржЙржирж┐ржЯ</th><th>рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕</th></tr></thead><tbody>`;
    DB.stock.forEach(s=>{
        const p=DB.products.find(x=>x.id===s.productId);
        const v=DB.vendors.find(x=>x.id===s.vendorId);
        if(p && v){
            h+=`<tr><td>${p.name}</td><td>${v.name}</td><td class="${s.qty<=p.minStock?'low':''}">${s.qty}</td><td>${p.unit}</td><td>${s.qty<=p.minStock?'тЪая╕П ржХржо':'тЬЕ ржнрж╛рж▓'}</td></tr>`;
        }
    });
    h+=`</tbody></table><p style="text-align:center;color:#666;font-size:12px">ржЬрзЗржирж╛рж░рзЗржЯ: ${new Date().toLocaleString()}</p>
    <script>window.onload=function(){window.print()}<\/script></body></html>`;
    w.document.write(h);w.document.close();
}

// ========== SETTINGS ==========
function initSettings(){
    $('openCash').value=getOpeningCash(today());
    
    // Fill filter dropdown for settings not needed as it's in stock page
    
    $('dataInfo').innerHTML=`
        ЁЯУж ржкржгрзНржп: <strong>${DB.products.length}</strong> | 
        ЁЯСд ржнрзЗржирзНржбрж░: <strong>${DB.vendors.length}</strong> | 
        ЁЯУж рж╕рзНржЯржХ ржЖржЗржЯрзЗржо: <strong>${DB.stock.length}</strong> | 
        ЁЯТ░ ржмрж┐ржХрзНрж░ржпрж╝: <strong>${DB.sales.length}</strong> | 
        ЁЯЫТ ржХрзНрж░ржпрж╝: <strong>${DB.purchases.length}</strong> | 
        ЁЯТ╕ ржЦрж░ржЪ: <strong>${DB.expenses.length}</strong><br>
        ЁЯТ╛ рж╕рж╛ржЗржЬ: <strong>${(JSON.stringify(DB).length/1024).toFixed(1)} KB</strong> | 
        ЁЯФД ржЖржкржбрзЗржЯ: <strong>${DB.lastUpdate?new Date(DB.lastUpdate).toLocaleString('bn-BD'):'ржирзЗржЗ'}</strong>
    `;
}

function setOpenCash(){
    if(!isShopOpen){toast('ржжрзЛржХрж╛ржи ржмржирзНржз!','error');return;}
    const amt=parseFloat($('openCash').value);
    if(isNaN(amt)||amt<0){toast('рж╕ржарж┐ржХ ржкрж░рж┐ржорж╛ржг ржжрж┐ржи','error');return}
    const t=today();
    if(!DB.dailyCash[t])DB.dailyCash[t]={};
    DB.dailyCash[t].opening=amt;
    DB.settings.openingCash=amt;
    save();
    toast('тЬЕ ржУржкрзЗржирж┐ржВ ржХрзНржпрж╛рж╢ рж╕рзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ');
}

function backupData(){
    const data=JSON.stringify(DB,null,2);
    downloadFile(data,'mainu_backup_'+today()+'.json','application/json');
    toast('тЬЕ ржмрзНржпрж╛ржХржЖржк ржбрж╛ржЙржирж▓рзЛржб рж╣ржпрж╝рзЗржЫрзЗ');
}

function restoreData(e){
    const file=e.target.files[0];
    if(!file)return;
    if(!confirm('тЪая╕П ржмрж░рзНрждржорж╛ржи ржбрж╛ржЯрж╛ ржкрзНрж░рждрж┐рж╕рзНржерж╛ржкрж┐ржд рж╣ржмрзЗред ржирж┐рж╢рзНржЪрж┐ржд?')){e.target.value='';return}
    
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const d=JSON.parse(ev.target.result);
            if(!d.products&&!d.sales){throw new Error('ржнрзБрж▓ ржлрж╛ржЗрж▓')}
            DB=d;
            if(!DB.expenses)DB.expenses=[];
            if(!DB.duePayments)DB.duePayments=[];
            if(!DB.vendorDuePayments)DB.vendorDuePayments=[];
            if(!DB.dailyCash)DB.dailyCash={};
            if(!DB.settings)DB.settings={};
            if(!DB.stock)DB.stock=[]; // Ensure stock array exists
            save();
            toast('тЬЕ ржбрж╛ржЯрж╛ ржкрзБржирж░рзБржжрзНржзрж╛рж░ рж╕ржлрж▓');
            setTimeout(()=>location.reload(),800);
        }catch(err){
            toast('тЭМ ржнрзБрж▓ ржлрж╛ржЗрж▓!','error');
        }
        e.target.value='';
    };
    reader.readAsText(file);
}

function resetAll(){
    if(currentUser.role !== 'admin'){
        toast('ржЕржирзБржорждрж┐ ржирзЗржЗ','error');
        return;
    }
    if(!confirm('тЪая╕П рж╕ржорж╕рзНржд ржбрж╛ржЯрж╛ ржорзБржЫрзЗ ржпрж╛ржмрзЗ! ржирж┐рж╢рзНржЪрж┐ржд?'))return;
    if(!confirm('рж╕рждрзНржпрж┐ржЗ рж╕ржм ржорзБржЫржмрзЗржи?'))return;
    localStorage.removeItem('mainuDB');
    toast('ЁЯЧСя╕П рж╕ржХрж▓ ржбрж╛ржЯрж╛ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗ','info');
    setTimeout(()=>location.reload(),800);
}

// ========== INIT ==========
function initApp(){
    const hasData=load();
    if(!hasData)initDefaults();
    renderDash();
}

// Periodic Auto-save
setInterval(()=>{save()},30000);

window.addEventListener('beforeunload',()=>save());

</script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

<script>
function saveOffline(){
  localStorage.setItem("mainuDB", JSON.stringify(DB));
}

function loadOffline(){
  const data = localStorage.getItem("mainuDB");
  if(data){
    DB = JSON.parse(data);
  }
}
  const firebaseConfig = {
    apiKey: "ржПржЦрж╛ржирзЗ ржЖржкржирж╛рж░ apiKey",
    authDomain: "ржПржЦрж╛ржирзЗ authDomain",
    databaseURL: "ржПржЦрж╛ржирзЗ databaseURL",
    projectId: "ржПржЦрж╛ржирзЗ projectId",
    storageBucket: "ржПржЦрж╛ржирзЗ storageBucket",
    messagingSenderId: "ржПржЦрж╛ржирзЗ senderId",
    appId: "ржПржЦрж╛ржирзЗ appId"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
</body>
</html>
